<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì§€êµ¬ë³¸ - ìŠ¤ë§ˆíŠ¸ ë³µì§€ ì§€ë„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        #map-wrapper { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; background: #f0f0f0; }

        .info-box {
            position: absolute; top: 10px; left: 60px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 260px;
            max-width: 300px;
            backdrop-filter: blur(5px);
        }
        
        h2 { margin: 0 0 5px 0; font-size: 18px; text-align: center; color: #2c3e50; }
        .section-title { font-size: 12px; font-weight: bold; color: #555; margin-top: 10px; margin-bottom: 5px; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-group { display: flex; gap: 5px; margin-bottom: 5px; }
        .layer-btn, .filter-btn {
            flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 8px;
            background: white; font-size: 12px; font-weight: bold; cursor: pointer;
            transition: all 0.2s;
        }
        .layer-btn.active.elderly { background: #e74c3c; color: white; border-color: #e74c3c; }
        .layer-btn.active.poverty { background: #e67e22; color: white; border-color: #e67e22; }
        
        .filter-btn:hover { background: #f0f0f0; }
        .filter-btn.active { background: #2c3e50; color: white; border-color: #2c3e50; }

        .legend-bar { height: 8px; width: 100%; border-radius: 4px; margin: 5px 0; }
        .legend-labels { display: flex; justify-content: space-between; font-size: 10px; color: #666; }

        .fullscreen-btn { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; border: 0; width: 40px; height: 40px; border-radius: 8px; font-size: 20px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* íŒì—… ì»¤ìŠ¤í…€ */
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; }
        .custom-popup .leaflet-popup-content { margin: 15px; text-align: center; }
    </style>
</head>
<body>

    <div id="map-wrapper">
        <button class="fullscreen-btn" onclick="toggleFullScreen()">â›¶</button>
        
        <div class="info-box">
            <h2>ì„œìš¸ì‹œ ë³µì§€ ì§€ë„</h2>
            <p style="font-size:11px; text-align:center; color:#666; margin-bottom:10px;">(ë°°ê²½: ì¸êµ¬í˜„í™© / í•€: ì‰¼í„°ìœ„ì¹˜)</p>

            <div class="section-title">ğŸ“Š ì§€ì—­ ë¶„ì„ ëª¨ë“œ</div>
            <div class="btn-group">
                <button class="layer-btn active elderly" onclick="setMode('elderly')">ğŸ”´ ê³ ë ¹ì</button>
                <button class="layer-btn poverty" onclick="setMode('poverty')">ğŸŸ  ì·¨ì•½ê³„ì¸µ</button>
            </div>
            <div class="legend-bar" id="legend-bar"></div>
            <div class="legend-labels">
                <span id="legend-min">ì ìŒ</span><span id="legend-max">ë§ìŒ</span>
            </div>

            <div class="section-title" style="margin-top:15px;">â›±ï¸ ë¬´ë”ìœ„ ì‰¼í„° í‘œì‹œ</div>
            <div class="btn-group">
                <button class="filter-btn active" onclick="filterShelter('all', this)">ì „ì²´</button>
                <button class="filter-btn" onclick="filterShelter('senior', this)">ğŸ‘´ ê²½ë¡œë‹¹</button>
                <button class="filter-btn" onclick="filterShelter('public', this)">ğŸ¢ ëˆ„êµ¬ë‚˜</button>
            </div>

            <p id="status" style="margin-top:15px; font-size:11px; color:blue; text-align:center;">ë°ì´í„° ë¡œë”© ì¤‘...</p>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        // ì§€ë„ ìƒì„±
        var map = L.map('map', { zoomControl: false }).setView([37.5665, 126.9780], 11);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);

        // ë³€ìˆ˜ ì„ ì–¸
        var geojsonLayer;
        var markerCluster = L.markerClusterGroup({ disableClusteringAtZoom: 16 }); // ì¤Œ ë‹¹ê¸°ë©´ í•€ ë¶„ì‚°
        var dongData = {};
        var shelterData = [];
        var currentMode = 'elderly';

        // íŒŒì¼ ê²½ë¡œ
        var dongCsvUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/seoul_dong_data.csv";
        var geojsonUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/seoul_dong.geojson";
        var shelterCsvUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/shelter_data.csv";

        // ì´ë¦„ ë§¤í•‘ (ë³´ì •ìš©)
        const nameMapping = { "ê°•ë‚¨êµ¬ ì¼ì›2ë™": "ê°•ë‚¨êµ¬ ê°œí¬3ë™", "ê°•ë™êµ¬ ìƒì¼ë™": "ê°•ë™êµ¬ ìƒì¼1ë™" };

        // ì‹¤í–‰ ìˆœì„œ: 1.ë™ë°ì´í„° -> 2.ì§€ë„ëª¨ì–‘ -> 3.ì‰¼í„°ë°ì´í„°
        document.getElementById('status').innerText = "1. ì§€ì—­ ë°ì´í„° ë¡œë”© ì¤‘...";

        Papa.parse(dongCsvUrl, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
            complete: function(results) {
                results.data.forEach(row => { if (row.full_name) dongData[row.full_name] = row; });
                document.getElementById('status').innerText = "2. ì§€ë„ ê·¸ë¦¬ëŠ” ì¤‘...";
                loadGeoJSON();
            },
            error: function() { alert("ë™ë³„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"); }
        });

        function loadGeoJSON() {
            fetch(geojsonUrl)
                .then(res => res.json())
                .then(data => {
                    geojsonLayer = L.geoJson(data, {
                        style: styleFeature,
                        onEachFeature: onEachFeature
                    }).addTo(map);
                    
                    document.getElementById('status').innerText = "3. ì‰¼í„° ìœ„ì¹˜ ì°ëŠ” ì¤‘...";
                    loadShelters(); // ì‰¼í„° ë¡œë”© ì‹œì‘
                })
                .catch(err => alert("ì§€ë„ íŒŒì¼ ë¡œë”© ì‹¤íŒ¨"));
        }

        function loadShelters() {
            Papa.parse(shelterCsvUrl, {
                download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
                complete: function(results) {
                    shelterData = results.data;
                    renderShelters('all'); // í•€ ì°ê¸°
                    setMode('elderly'); // ì´ˆê¸° ëª¨ë“œ ì„¤ì •
                    document.getElementById('status').innerText = "âœ… í†µí•© ë¶„ì„ ì™„ë£Œ";
                }
            });
        }

        // --- ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---

        // 1. ì‰¼í„° í•€ ì°ê¸°
        function renderShelters(category) {
            markerCluster.clearLayers(); // ê¸°ì¡´ í•€ ì‚­ì œ
            
            shelterData.forEach(row => {
                var lat = row['ìœ„ë„'] || row['WGS84ìœ„ë„'];
                var lng = row['ê²½ë„'] || row['WGS84ê²½ë„'];
                var name = row['ì‰¼í„°ëª…ì¹­'] || row['ì‰¼í„°ëª…'] || "ì´ë¦„ì—†ìŒ";
                
                if (lat && lng) {
                    var isSenior = name.includes("ê²½ë¡œë‹¹") || name.includes("ë…¸ì¸");
                    var show = (category === 'all') || (category === 'senior' && isSenior) || (category === 'public' && !isSenior);
                    
                    if (show) {
                        var marker = L.marker([lat, lng]);
                        marker.bindPopup(`<b>${name}</b>`);
                        markerCluster.addLayer(marker);
                    }
                }
            });
            map.addLayer(markerCluster);
        }

        // 2. ì‰¼í„° í•„í„° ë²„íŠ¼
        function filterShelter(category, btnElement) {
            var group = btnElement.parentElement;
            group.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            renderShelters(category);
        }

        // 3. ë‹¨ê³„êµ¬ë¶„ë„ ìŠ¤íƒ€ì¼ë§
        function getDataByFeature(feature) {
            var rawName = feature.properties.adm_nm || feature.properties.name || "";
            var parts = rawName.split(" ");
            var keyName = parts.length >= 3 ? parts[1] + " " + parts[2] : rawName;
            keyName = keyName.replace(/Â·/g, ".");
            if (nameMapping[keyName]) keyName = nameMapping[keyName];
            return dongData[keyName] || { elderly: 0, poverty: 0 };
        }

        function styleFeature(feature) {
            var data = getDataByFeature(feature);
            var value = (currentMode === 'elderly') ? data.elderly : data.poverty;
            return { fillColor: getColor(value), weight: 1, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.6 };
        }

        function getColor(d) {
            if (currentMode === 'elderly') {
                return d > 8000 ? '#800026' : d > 6000 ? '#BD0026' : d > 4000 ? '#E31A1C' : d > 2000 ? '#FC4E2A' : '#FFEDA0';
            } else {
                return d > 2500 ? '#7f2704' : d > 2000 ? '#a63603' : d > 1500 ? '#d94801' : d > 1000 ? '#f16913' : '#feedde';
            }
        }

        function onEachFeature(feature, layer) {
            var data = getDataByFeature(feature);
            var shortName = (feature.properties.adm_nm || "").split(" ").pop();
            layer.bindPopup(`<div style="text-align:center;"><b>${shortName}</b><br>ğŸ”´ ê³ ë ¹ì: ${data.elderly}ëª…<br>ğŸŸ  ìˆ˜ê¸‰ì: ${data.poverty}ëª…</div>`, { className: 'custom-popup' });
            layer.on({
                mouseover: function(e) { e.target.setStyle({ weight: 3, color: '#333', fillOpacity: 0.8 }); e.target.openPopup(); },
                mouseout: function(e) { geojsonLayer.resetStyle(e.target); e.target.closePopup(); },
                click: function(e) { map.fitBounds(e.target.getBounds()); }
            });
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.layer-btn.' + mode).classList.add('active');
            
            var bar = document.getElementById('legend-bar');
            bar.style.background = mode === 'elderly' ? 'linear-gradient(to right, #FFEDA0, #800026)' : 'linear-gradient(to right, #feedde, #7f2704)';
            
            if(geojsonLayer) geojsonLayer.setStyle(styleFeature);
        }

        function toggleFullScreen() {
            var el = document.getElementById('map-wrapper');
            if(!document.fullscreenElement) el.requestFullscreen(); else document.exitFullscreen();
        }
    </script>
</body>
</html>
