<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì§€êµ¬ë³¸ - ìŠ¤ë§ˆíŠ¸ ë³µì§€ ì§€ë„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        #map-wrapper { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; background: #f0f0f0; }

        .info-box {
            position: absolute; top: 10px; left: 60px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 260px;
        }
        .layer-btn {
            padding: 8px; border: 1px solid #ddd; background: white; cursor: pointer; width: 48%;
        }
        .layer-btn.active { background: #2c3e50; color: white; }
        .fullscreen-btn { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; border: 0; width: 40px; height: 40px; border-radius: 8px; font-size: 20px; cursor: pointer; }
        
        .legend-bar { height: 10px; width: 100%; background: linear-gradient(to right, #feedde, #a63603); margin: 5px 0; }
        
        /* íŒì—… ìŠ¤íƒ€ì¼ */
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 10px; }
        .popup-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div id="map-wrapper">
        <button class="fullscreen-btn" onclick="toggleFullScreen()">â›¶</button>
        <div class="info-box">
            <h2 style="margin:0 0 5px 0; font-size:18px; text-align:center;">ì„œìš¸ì‹œ ë³µì§€ ì§€ë„</h2>
            <p style="font-size:11px; text-align:center; color:#666; margin-bottom:15px;">2026.01.01 ë°ì´í„° ê¸°ì¤€</p>

            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="layer-btn active" onclick="setMode('elderly')">ğŸ”´ ê³ ë ¹ì</button>
                <button class="layer-btn" onclick="setMode('poverty')">ğŸŸ  ì·¨ì•½ê³„ì¸µ</button>
            </div>
            
            <div class="legend-bar" id="legend-bar"></div>
            <div style="display:flex; justify-content:space-between; font-size:11px; color:#666;">
                <span id="legend-min">ì ìŒ</span><span id="legend-max">ë§ìŒ</span>
            </div>
            
            <p id="status" style="margin-top:10px; font-size:12px; color:blue; text-align:center;">ì§€ë„ ì¤€ë¹„ ì¤‘...</p>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        // ì„œìš¸ì‹œ ì¤‘ì‹¬ ì¢Œí‘œ
        var map = L.map('map').setView([37.5665, 126.9780], 11);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);

        var geojsonLayer;
        var dongData = {};
        var currentMode = 'elderly';

        // â˜… 1. ë°ì´í„° íŒŒì¼ (CSV) ì£¼ì†Œ
        var csvUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/seoul_dong_data.csv";
        
        // â˜… 2. ì§€ë„ ëª¨ì–‘ íŒŒì¼ (GeoJSON) ì£¼ì†Œ (ì„ ìƒë‹˜ ê¹ƒí—ˆë¸Œ)
        var geojsonUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/seoul_dong.geojson";

        // ì‹¤í–‰ ì‹œì‘
        document.getElementById('status').innerText = "1. ì¸êµ¬ ë°ì´í„° ë¡œë”© ì¤‘...";

        Papa.parse(csvUrl, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
            complete: function(results) {
                // ë™ ì´ë¦„ìœ¼ë¡œ ë°ì´í„° ì •ë¦¬
                results.data.forEach(row => {
                    // GeoJSONì˜ ì´ë¦„(ë™ ì´ë¦„)ê³¼ ë§¤ì¹­í•˜ê¸° ìœ„í•´ ì €ì¥
                    if (row.dong) dongData[row.dong] = row;
                });
                
                document.getElementById('status').innerText = "2. ì§€ë„ ëª¨ì–‘ ê·¸ë¦¬ëŠ” ì¤‘...";
                loadGeoJSON();
            },
            error: function() { alert("CSV ë°ì´í„° ë¡œë”© ì‹¤íŒ¨! íŒŒì¼ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”."); }
        });

        function loadGeoJSON() {
            fetch(geojsonUrl)
                .then(res => {
                    if (!res.ok) throw new Error("ì§€ë„ íŒŒì¼(seoul_dong.geojson)ì´ ì—†ìŠµë‹ˆë‹¤.");
                    return res.json();
                })
                .then(data => {
                    geojsonLayer = L.geoJson(data, {
                        style: styleFeature,
                        onEachFeature: onEachFeature
                    }).addTo(map);
                    document.getElementById('status').innerText = "âœ… ë¶„ì„ ì™„ë£Œ";
                })
                .catch(err => {
                    alert("âš ï¸ ì§€ë„ ë¡œë”© ì‹¤íŒ¨!\n" + err);
                    document.getElementById('status').innerText = "âŒ ì§€ë„ íŒŒì¼ ì—†ìŒ";
                });
        }

        function styleFeature(feature) {
            // GeoJSON íŒŒì¼ì˜ ë™ ì´ë¦„ (adm_nm í˜¹ì€ temp ë“± íŒŒì¼ë§ˆë‹¤ ë‹¤ë¦„)
            // ë³´í†µ 'adm_nm'ì— 'ì„œìš¸ ì¢…ë¡œêµ¬ ì‚¬ì§ë™' í˜•íƒœë¡œ ë“¤ì–´ìˆìŒ
            var fullName = feature.properties.adm_nm || feature.properties.name || ""; 
            var dongName = fullName.split(" ").pop(); // "ì‚¬ì§ë™"ë§Œ ì¶”ì¶œ

            var data = dongData[dongName];
            var value = 0;
            if (data) value = (currentMode === 'elderly') ? data.elderly : data.poverty;

            return {
                fillColor: getColor(value),
                weight: 1, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.75
            };
        }

        function getColor(d) {
            if (currentMode === 'elderly') {
                return d > 6000 ? '#800026' : d > 5000 ? '#BD0026' : d > 4000 ? '#E31A1C' :
                       d > 3000 ? '#FC4E2A' : d > 2000 ? '#FD8D3C' : d > 1000 ? '#FEB24C' : '#FFEDA0';
            } else {
                return d > 2000 ? '#7f2704' : d > 1500 ? '#a63603' : d > 1000 ? '#d94801' :
                       d > 700 ? '#f16913' : d > 400 ? '#fd8d3c' : d > 200 ? '#fdae6b' : '#feedde';
            }
        }

        function onEachFeature(feature, layer) {
            var fullName = feature.properties.adm_nm || feature.properties.name || "ì´ë¦„ì—†ìŒ";
            var dongName = fullName.split(" ").pop();
            var data = dongData[dongName] || { elderly: 0, poverty: 0 };
            
            var content = `
                <div style="text-align:center; font-family:'Pretendard';">
                    <h3 style="margin:0 0 5px 0; color:#333;">${dongName}</h3>
                    <div class="popup-row"><span>ğŸ”´ ê³ ë ¹ì:</span> <b>${data.elderly.toLocaleString()}ëª…</b></div>
                    <div class="popup-row"><span>ğŸŸ  ìˆ˜ê¸‰ì:</span> <b>${data.poverty.toLocaleString()}ëª…</b></div>
                </div>
            `;
            layer.bindPopup(content, { className: 'custom-popup' });
            
            layer.on({
                mouseover: function(e) { e.target.setStyle({ weight: 3, color: '#333', fillOpacity: 0.9 }); },
                mouseout: function(e) { geojsonLayer.resetStyle(e.target); }
            });
        }

        function setMode(mode) {
            currentMode = mode;
            var btns = document.querySelectorAll('.layer-btn');
            btns[0].className = mode === 'elderly' ? 'layer-btn active' : 'layer-btn';
            btns[1].className = mode === 'poverty' ? 'layer-btn active' : 'layer-btn';
            
            var bar = document.getElementById('legend-bar');
            bar.style.background = mode === 'elderly' ? 
                'linear-gradient(to right, #FFEDA0, #800026)' : 'linear-gradient(to right, #feedde, #7f2704)';
            
            if(geojsonLayer) geojsonLayer.setStyle(styleFeature);
        }

        function toggleFullScreen() {
            var el = document.getElementById('map-wrapper');
            if(!document.fullscreenElement) el.requestFullscreen();
            else document.exitFullscreen();
        }
    </script>
</body>
</html>
