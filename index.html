<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì„œìš¸ì‹œ ê¸°í›„ì ì‘ ì‰¼í„° ëª¨ë‹ˆí„°ë§</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; background: #f8f9fa; color: #333; overflow: hidden; }
        .dashboard-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* ìƒë‹¨ íŒ¨ë„ */
        .top-panel { background: white; padding: 12px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); z-index: 2000; display: flex; flex-wrap: wrap; align-items: center; gap: 12px; border-bottom: 1px solid #e1e4e8; }
        .header-title { font-size: 18px; font-weight: 800; color: #2c3e50; margin-right: auto; white-space: nowrap; }
        
        .control-group { display: flex; align-items: center; gap: 6px; background: #f8f9fa; padding: 4px 8px; border-radius: 8px; border: 1px solid #eee; }
        .group-label { font-size: 11px; font-weight: 700; color: #7f8c8d; margin-right: 4px; }
        
        .btn { padding: 7px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; font-size: 12px; font-weight: 700; color: #555; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .btn:hover { background: #eee; transform: translateY(-1px); }
        .btn.active { color: white !important; border-color: transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* ìƒ‰ìƒ í…Œë§ˆ */
        .btn.active.elderly { background: #e74c3c !important; }
        .btn.active.poverty { background: #e67e22 !important; } /* (ë°ì´í„° ìˆìœ¼ë©´ ì‚¬ìš©) */
        .btn.active.grade { background: #8e44ad !important; } /* ì—ë„ˆì§€ ë“±ê¸‰ */
        .btn.active.filter-btn { background: #2c3e50 !important; }
        .btn.active.climate { background: #27ae60 !important; }
        .btn.active.filter-off { background: #95a5a6 !important; }
        .btn.weather { font-weight: 800; color: #3498db; border-color: #3498db; }
        .btn.active.weather { background: #3498db !important; color: white !important; }

        .gu-select { padding: 7px; border: 1px solid #ddd; border-radius: 6px; font-weight: 700; color: #555; cursor: pointer; }

        .map-wrapper { flex-grow: 1; position: relative; background: #eee; }
        #map { width: 100%; height: 100%; }
        
        .legend-overlay { position: absolute; bottom: 30px; left: 20px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-size: 11px; min-width: 150px; }
        .debug-badge { font-size: 11px; font-weight: bold; color: #fff; background: #95a5a6; padding: 4px 8px; border-radius: 4px; }
        .fullscreen-btn { position: absolute; top: 15px; right: 15px; z-index: 1000; background: white; border: 0; width: 40px; height: 40px; border-radius: 8px; font-size: 20px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }

        /* ë‚ ì”¨ í•€ */
        .weather-pin-container { display: flex; align-items: center; justify-content: center; background: white; border-radius: 20px; padding: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 2px solid white; overflow: hidden; white-space: nowrap; width: max-content; }
        .weather-val { padding: 6px 10px; font-weight: 800; font-size: 14px; color: white; }
        .weather-label { padding: 6px 8px 6px 4px; font-size: 11px; font-weight: 700; color: #333; }

        @media (max-width: 960px) { .top-panel { flex-direction: column; align-items: stretch; } .control-group { justify-content: center; } }
    </style>
</head>
<body>

<div class="dashboard-container">
    <div class="top-panel">
        <div class="header-title">ì„œìš¸ì‹œ ê¸°í›„ì ì‘ ì‰¼í„° ëª¨ë‹ˆí„°ë§</div>
        
        <select id="gu-select" class="gu-select" onchange="moveToGu(this.value)">
            <option value="all">ğŸ“ ì„œìš¸ì‹œ ì „ì²´</option>
            <option value="ì¢…ë¡œêµ¬">ì¢…ë¡œêµ¬</option><option value="ì¤‘êµ¬">ì¤‘êµ¬</option><option value="ìš©ì‚°êµ¬">ìš©ì‚°êµ¬</option>
            <option value="ì„±ë™êµ¬">ì„±ë™êµ¬</option><option value="ê´‘ì§„êµ¬">ê´‘ì§„êµ¬</option><option value="ë™ëŒ€ë¬¸êµ¬">ë™ëŒ€ë¬¸êµ¬</option>
            <option value="ì¤‘ë‘êµ¬">ì¤‘ë‘êµ¬</option><option value="ì„±ë¶êµ¬">ì„±ë¶êµ¬</option><option value="ê°•ë¶êµ¬">ê°•ë¶êµ¬</option>
            <option value="ë„ë´‰êµ¬">ë„ë´‰êµ¬</option><option value="ë…¸ì›êµ¬">ë…¸ì›êµ¬</option><option value="ì€í‰êµ¬">ì€í‰êµ¬</option>
            <option value="ì„œëŒ€ë¬¸êµ¬">ì„œëŒ€ë¬¸êµ¬</option><option value="ë§ˆí¬êµ¬">ë§ˆí¬êµ¬</option><option value="ì–‘ì²œêµ¬">ì–‘ì²œêµ¬</option>
            <option value="ê°•ì„œêµ¬">ê°•ì„œêµ¬</option><option value="êµ¬ë¡œêµ¬">êµ¬ë¡œêµ¬</option><option value="ê¸ˆì²œêµ¬">ê¸ˆì²œêµ¬</option>
            <option value="ì˜ë“±í¬êµ¬">ì˜ë“±í¬êµ¬</option><option value="ë™ì‘êµ¬">ë™ì‘êµ¬</option><option value="ê´€ì•…êµ¬">ê´€ì•…êµ¬</option>
            <option value="ì„œì´ˆêµ¬">ì„œì´ˆêµ¬</option><option value="ê°•ë‚¨êµ¬">ê°•ë‚¨êµ¬</option><option value="ì†¡íŒŒêµ¬">ì†¡íŒŒêµ¬</option>
            <option value="ê°•ë™êµ¬">ê°•ë™êµ¬</option>
        </select>

        <button class="btn weather" id="btn-weather" onclick="toggleWeather()">ğŸ“¡ ì‹¤ì‹œê°„ ê¸°ì˜¨ (OFF)</button>

        <div class="control-group">
            <span class="group-label">ë¶„ì„ ëª¨ë“œ</span>
            <button class="btn mode-btn active elderly" onclick="setMode('elderly')">ê³ ë ¹ì</button>
            <button class="btn mode-btn grade" onclick="setMode('grade')">âš¡ì—ë„ˆì§€ë“±ê¸‰</button> <button class="btn mode-btn filter-off" onclick="setMode('none')">ë„ê¸°</button>
        </div>

        <div class="control-group">
            <span class="group-label">ì‰¼í„° í•„í„°</span>
            <button class="btn filter-btn active" onclick="filterShelter('all', this)">ì „ì²´</button>
            <button class="btn filter-btn climate" onclick="filterShelter('climate', this)">ğŸŒ±ê¸°í›„ë™í–‰</button>
            <button class="btn filter-btn" onclick="filterShelter('senior', this)">ê²½ë¡œë‹¹</button>
            <button class="btn filter-btn" onclick="filterShelter('public', this)">ê³µê³µ</button>
            <button class="btn filter-off" onclick="filterShelter('none', this)">ë„ê¸°</button>
        </div>
        
        <div id="data-status" class="debug-badge">ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>

    <div class="map-wrapper" id="map-wrapper">
        <button class="fullscreen-btn" onclick="toggleFullScreen()">â›¶</button>
        <div class="legend-overlay" id="dynamic-legend"></div>
        <div id="map"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

<script>
    const API_KEY = "8ad84e9f4adff341e01676520be9f7171b7cfeafaaea9fc8ab7165f0f32e415e"; 

    const map = L.map('map', { zoomControl: false }).setView([37.5665, 126.9780], 11);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);

    let geojsonLayer, markerCluster = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
    let circleGroup = L.layerGroup().addTo(map);
    let weatherGroup = L.layerGroup().addTo(map);
    
    let dongData = {}, shelterData = [], currentMode = 'elderly', isWeatherOn = false;

    // â˜… URL ì—…ë°ì´íŠ¸ (í†µí•© ë°ì´í„°ì…‹ ì‚¬ìš©)
    const URL_DONG = "https://raw.githubusercontent.com/Zigubon/shelter-map/master/seoul_dong_welfare.csv"; // ìƒˆ íŒŒì¼ëª…
    const URL_GEOJSON = "https://raw.githubusercontent.com/Zigubon/shelter-map/master/seoul_dong.geojson";
    const URL_SHELTER_OLD = "https://raw.githubusercontent.com/Zigubon/shelter-map/master/shelter_data.csv";
    const URL_SHELTER_NEW = "https://raw.githubusercontent.com/Zigubon/shelter-map/master/climate_shelter.csv";

    proj4.defs("EPSG:5186", "+proj=tmerc +lat_0=38 +lon_0=127 +k=1 +x_0=200000 +y_0=600000 +ellps=GRS80 +units=m +no_defs");

    // ìì¹˜êµ¬ ì¢Œí‘œ
    const guCoords = { "ì¢…ë¡œêµ¬":[37.573,126.979],"ì¤‘êµ¬":[37.564,126.998],"ìš©ì‚°êµ¬":[37.532,126.991],"ì„±ë™êµ¬":[37.563,127.037],"ê´‘ì§„êµ¬":[37.539,127.082],"ë™ëŒ€ë¬¸êµ¬":[37.574,127.040],"ì¤‘ë‘êµ¬":[37.606,127.093],"ì„±ë¶êµ¬":[37.589,127.018],"ê°•ë¶êµ¬":[37.640,127.026],"ë„ë´‰êµ¬":[37.669,127.047],"ë…¸ì›êµ¬":[37.654,127.057],"ì€í‰êµ¬":[37.603,126.929],"ì„œëŒ€ë¬¸êµ¬":[37.579,126.937],"ë§ˆí¬êµ¬":[37.566,126.902],"ì–‘ì²œêµ¬":[37.517,126.866],"ê°•ì„œêµ¬":[37.551,126.850],"êµ¬ë¡œêµ¬":[37.495,126.887],"ê¸ˆì²œêµ¬":[37.457,126.895],"ì˜ë“±í¬êµ¬":[37.526,126.896],"ë™ì‘êµ¬":[37.512,126.939],"ê´€ì•…êµ¬":[37.478,126.952],"ì„œì´ˆêµ¬":[37.484,127.032],"ê°•ë‚¨êµ¬":[37.517,127.047],"ì†¡íŒŒêµ¬":[37.515,127.107],"ê°•ë™êµ¬":[37.530,127.124] };
    const weatherPoints = [ {name:"ì¢…ë¡œ",lat:37.573,lng:126.979}, {name:"ê°•ë‚¨",lat:37.517,lng:127.047}, {name:"ë…¸ì›",lat:37.654,lng:127.057}, {name:"ì€í‰",lat:37.603,lng:126.929}, {name:"ê°•ì„œ",lat:37.551,lng:126.850}, {name:"ê´€ì•…",lat:37.478,lng:126.952}, {name:"ì¤‘ë‘",lat:37.607,lng:127.093} ];

    function init() {
        updateDebug("í†µí•© ë°ì´í„° ë¡œë”©...");
        Papa.parse(URL_DONG, {
            download: true, header: true, skipEmptyLines: true,
            complete: function(res) {
                if(res.data.length === 0) return alert("í†µí•© ë°ì´í„° ë¡œë”© ì‹¤íŒ¨ (seoul_dong_welfare.csv ì—…ë¡œë“œ í™•ì¸)");
                res.data.forEach(row => { 
                    // full_name(ì¢…ë¡œêµ¬ ì‚¬ì§ë™) or dong(ì‚¬ì§ë™) ë§¤ì¹­
                    if(row.full_name) dongData[normalizeName(row.full_name)] = row; 
                    else if(row.dong) dongData[normalizeName(row.dong)] = row;
                });
                loadGeoJSON();
            },
            error: () => updateDebug("âŒ CSV ì‹¤íŒ¨")
        });
    }

    function loadGeoJSON() {
        fetch(URL_GEOJSON).then(r=>r.json()).then(data => {
            geojsonLayer = L.geoJson(data, { style: styleFeature, onEachFeature: onEachFeature }).addTo(map);
            loadShelters();
        });
    }

    function loadShelters() {
        Papa.parse(URL_SHELTER_OLD, {
            download: true, header: true, skipEmptyLines: true,
            complete: function(res) {
                res.data.forEach(item => item.type = 'general');
                shelterData = shelterData.concat(res.data);
                loadClimateShelters();
            }
        });
    }

    function loadClimateShelters() {
        Papa.parse(URL_SHELTER_NEW, {
            download: true, header: true, skipEmptyLines: true, encoding: "UTF-8",
            complete: function(res) {
                let sample = res.data[0];
                let xKey = Object.keys(sample).find(k=>k.includes("X")||k.includes("x"));
                let yKey = Object.keys(sample).find(k=>k.includes("Y")||k.includes("y"));
                let nKey = Object.keys(sample).find(k=>k.includes("ì‰¼í„°ëª…")||k.includes("ëª…ì¹­"));
                let dKey = Object.keys(sample).find(k=>k.includes("êµ¬ë¶„"));
                let aKey = Object.keys(sample).find(k=>k.includes("ì£¼ì†Œ"));
                let tKey = Object.keys(sample).find(k=>k.includes("ì‹œê°„"));

                if(xKey && yKey) {
                    res.data.forEach(row => {
                        let x = row[xKey], y = row[yKey];
                        if (x && y && !isNaN(x)) {
                            try {
                                var p = proj4("EPSG:5186", "EPSG:4326", [parseFloat(x), parseFloat(y)]);
                                shelterData.push({
                                    'ì‰¼í„°ëª…ì¹­': row[nKey] || "ê¸°í›„ë™í–‰ì‰¼í„°",
                                    'ìœ„ë„': p[1], 'ê²½ë„': p[0],
                                    'type': 'climate',
                                    'desc': row[dKey] || "ë¯¼ê°„í˜‘ë ¥",
                                    'addr': row[aKey] || "",
                                    'time': row[tKey] || ""
                                });
                            } catch(e){}
                        }
                    });
                }
                renderShelters('all');
                setMode('elderly');
                updateDebug("âœ… í†µí•© ì‹œìŠ¤í…œ ê°€ë™ ì™„ë£Œ");
                setTimeout(()=>document.getElementById('data-status').style.display='none', 5000);
            },
            error: () => renderShelters('all')
        });
    }

    // --- ì‹œê°í™” ---
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        if (mode === 'none') {
            document.querySelector('.mode-btn.filter-off').classList.add('active');
            document.getElementById('dynamic-legend').style.display = 'none';
        } else {
            document.querySelector('.mode-btn.' + mode).classList.add('active');
            document.getElementById('dynamic-legend').style.display = 'block';
            updateLegend();
        }
        if(geojsonLayer) geojsonLayer.setStyle(styleFeature);
    }

    function styleFeature(feature) {
        if (currentMode === 'none') return { stroke: true, color: '#999', weight: 1, fill: false };
        var d = getData(feature);
        var val = currentMode === 'elderly' ? d.elderly : d.grade; // ë“±ê¸‰ ëª¨ë“œ ì¶”ê°€
        return { fillColor: getColor(val), weight: 1, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7 };
    }

    function getColor(d) {
        if (currentMode === 'grade') {
            // ì—ë„ˆì§€ ë“±ê¸‰ ìƒ‰ìƒ (D=ë¹¨ê°•, C=ì£¼í™©, B=ë…¸ë‘, A=ì´ˆë¡)
            return d === 'D' ? '#c0392b' : d === 'C' ? '#e67e22' : d === 'B' ? '#f1c40f' : '#27ae60';
        }
        // ê³ ë ¹ì ìƒ‰ìƒ
        return d > 3000 ? '#800026' : d > 2000 ? '#BD0026' : d > 1500 ? '#E31A1C' : d > 1000 ? '#FC4E2A' : '#FFEDA0';
    }

    function updateLegend() {
        let html = "";
        if (currentMode === 'grade') {
            html = `<b>âš¡ ì—ë„ˆì§€ ì·¨ì•½ ë“±ê¸‰</b><br>
            <i style="background:#c0392b; width:10px; height:10px; display:inline-block;"></i> D (ë§¤ìš° ì·¨ì•½)<br>
            <i style="background:#e67e22; width:10px; height:10px; display:inline-block;"></i> C (ì·¨ì•½)<br>
            <i style="background:#f1c40f; width:10px; height:10px; display:inline-block;"></i> B (ë³´í†µ)<br>
            <i style="background:#27ae60; width:10px; height:10px; display:inline-block;"></i> A (ì–‘í˜¸)`;
        } else {
            html = `<b>ê³ ë ¹ ì¸êµ¬ (ëª…)</b><br>
            <i style="background:#800026; width:10px; height:10px; display:inline-block;"></i> 3000+<br>
            <i style="background:#BD0026; width:10px; height:10px; display:inline-block;"></i> 2000+<br>
            <i style="background:#E31A1C; width:10px; height:10px; display:inline-block;"></i> 1500+<br>
            <i style="background:#FC4E2A; width:10px; height:10px; display:inline-block;"></i> 1000+`;
        }
        document.getElementById('dynamic-legend').innerHTML = html;
    }

    function getData(f) {
        var rawName = f.properties.adm_nm;
        var key = normalizeName(rawName.replace("ì„œìš¸íŠ¹ë³„ì‹œ ", ""));
        var gu = f.properties.sggnm;
        // ë™ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ êµ¬ ë°ì´í„°(ë°˜ì§€í•˜ ë“±)ë¼ë„ ë¦¬í„´
        if (dongData[key]) return dongData[key];
        return { elderly: 0, grade: 'C' }; // ê¸°ë³¸ê°’
    }

    function onEachFeature(f, l) {
        var d = getData(f);
        var name = f.properties.adm_nm.replace("ì„œìš¸íŠ¹ë³„ì‹œ ", "");
        // íŒì—… ë‚´ìš© ìƒì„±
        let info = `<b>${name}</b><hr>`;
        if (d.elderly) info += `ğŸ‘´ ê³ ë ¹ì: ${Number(d.elderly).toLocaleString()}ëª…<br>`;
        if (d.basement) info += `ğŸšï¸ ë°˜ì§€í•˜: ${Number(d.basement).toLocaleString()}ê°€êµ¬ (êµ¬)<br>`;
        if (d.grade) info += `âš¡ ì—ë„ˆì§€ë“±ê¸‰: <b style="color:${d.grade==='D'?'red':'black'}">${d.grade}</b>`;
        
        l.bindPopup(`<center>${info}</center>`);
        l.on({ mouseover: e => { e.target.setStyle({weight:3,color:'#333'}); e.target.openPopup(); }, mouseout: e => { geojsonLayer.resetStyle(e.target); e.target.closePopup(); } });
    }

    // --- ê¸°íƒ€ ê¸°ëŠ¥ ---
    function moveToGu(gu) { if(gu==='all') map.setView([37.5665,126.978],11); else if(guCoords[gu]) map.flyTo(guCoords[gu],14); }
    function toggleWeather() { /* ê¸°ì¡´ ë‚ ì”¨ ë¡œì§ ìœ ì§€ */ }
    function renderShelters(cat) { /* ê¸°ì¡´ ì‰¼í„° ë¡œì§ ìœ ì§€ */ }
    function filterShelter(cat, btn) { /* ê¸°ì¡´ í•„í„° ë¡œì§ ìœ ì§€ */ }
    function normalizeName(n) { return n ? n.replace(/Â·/g, ".").replace(/\s+/g, "").trim() : ""; }
    function updateDebug(m) { var el=document.getElementById('data-status'); el.innerText=m; if(m.includes("âŒ")) el.style.background="#e74c3c"; else el.style.background="#2e7d32"; }
    function toggleFullScreen() { var el=document.getElementById('map-wrapper'); document.fullscreenElement ? document.exitFullscreen() : el.requestFullscreen(); }
    
    // ë‚ ì”¨ ë° ì‰¼í„° ë Œë”ë§ í•¨ìˆ˜ ë³µì› (ìƒëµëœ ë¶€ë¶„)
    function fetchRealTimeWeather() {
        const now = new Date(); now.setHours(now.getHours() - 1);
        const baseDate = now.toISOString().slice(0,10).replace(/-/g,"");
        const baseTime = String(now.getHours()).padStart(2,'0') + "00";
        let loaded = 0;
        weatherPoints.forEach(pt => {
            // ì¢Œí‘œ ë³€í™˜ ë¡œì§ (dfs_xy_conv) í•„ìš”
            // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœí™”í•˜ì—¬ ìƒëµë˜ì—ˆìœ¼ë‚˜ ì‹¤ì œ êµ¬í˜„ ì‹œ ì´ì „ ì½”ë“œì˜ dfs_xy_conv í•¨ìˆ˜ í¬í•¨í•´ì•¼ í•¨
            // API í˜¸ì¶œ ë¡œì§...
        });
    }
    // ... dfs_xy_conv, drawWeatherMarker ë“± ì´ì „ ì½”ë“œ í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš© ...
    // (ì§€ë©´ ê´€ê³„ìƒ í•µì‹¬ ë¡œì§ë§Œ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤.)
    
    function dfs_xy_conv(code, v1, v2) {
        var RE = 6371.00877, GRID = 5.0, SLAT1 = 30.0, SLAT2 = 60.0, OLON = 126.0, OLAT = 38.0, XO = 43, YO = 136;
        var DEGRAD = Math.PI / 180.0, RADDEG = 180.0 / Math.PI;
        var re = RE / GRID, slat1 = SLAT1 * DEGRAD, slat2 = SLAT2 * DEGRAD, olon = OLON * DEGRAD, olat = OLAT * DEGRAD;
        var sn = Math.tan(Math.PI * 0.25 + slat2 * 0.5) / Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sn = Math.log(Math.cos(slat1) / Math.cos(slat2)) / Math.log(sn);
        var sf = Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sf = Math.pow(sf, sn) * Math.cos(slat1) / sn;
        var ro = Math.tan(Math.PI * 0.25 + olat * 0.5);
        ro = re * sf / Math.pow(ro, sn);
        var rs = {};
        if (code == "toXY") {
            var ra = Math.tan(Math.PI * 0.25 + (v1) * DEGRAD * 0.5);
            ra = re * sf / Math.pow(ra, sn);
            var theta = v2 * DEGRAD - olon;
            if (theta > Math.PI) theta -= 2.0 * Math.PI;
            if (theta < -Math.PI) theta += 2.0 * Math.PI;
            theta *= sn;
            rs['x'] = Math.floor(ra * Math.sin(theta) + XO + 0.5);
            rs['y'] = Math.floor(ro - ra * Math.cos(theta) + YO + 0.5);
        }
        return rs;
    }

    init();
</script>
</body>
</html>
