<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì§€êµ¬ë³¸ - ë¬´ë”ìœ„ ì‰¼í„° ëª¨ë‹ˆí„°ë§</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        #map-wrapper { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; }
        
        .info-box {
            position: absolute; top: 10px; left: 60px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: center; min-width: 260px;
            backdrop-filter: blur(5px);
        }
        h2 { margin: 0 0 5px 0; font-size: 18px; color: #2c3e50; font-weight: 800; }
        
        .legend-box {
            background: #f1f3f5; padding: 12px; border-radius: 8px; margin-bottom: 15px;
            font-size: 13px; text-align: left; font-weight: 600;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; }
        .dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; margin-right: 8px; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.2); }

        .district-select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .filter-group { display: flex; gap: 5px; justify-content: center; margin-bottom: 10px; flex-wrap: wrap; }
        .filter-btn { background: #fff; border: 1px solid #dee2e6; color: #495057; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .filter-btn.active { background: #2c3e50; color: white; border-color: #2c3e50; }
        
        .vul-btn.elderly.active { background: #e74c3c; border-color: #e74c3c; color: white; }
        .vul-btn.poverty.active { background: #e67e22; border-color: #e67e22; color: white; }

        .gps-btn { background: #3498db; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; }
        .fullscreen-btn { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; border: none; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 20px; }
    </style>
</head>
<body>

    <div id="map-wrapper">
        <button class="fullscreen-btn" onclick="toggleFullScreen()">â›¶</button>

        <div class="info-box">
            <h2>ğŸŒ ìŠ¤ë§ˆíŠ¸ ì‰¼í„° ì§€ë„ (ë™ë³„ ë¶„ì„)</h2>
            <p style="font-size:11px; color:#666; margin-bottom:10px; line-height:1.4;">
                ğŸ“… 2026-01-01 ê¸°ì¤€ ì—…ë°ì´íŠ¸<br>
                (ê³ ë ¹ìÂ·ìˆ˜ê¸‰ì ë°ì´í„° íƒ‘ì¬ ì™„ë£Œ)
            </p>

            <div class="legend-box">
                <div class="legend-item"><span class="dot" style="background:#e74c3c;"></span> ğŸ”´ ê³ ë ¹ì ë°€ì§‘ (ë™)</div>
                <div class="legend-item"><span class="dot" style="background:#e67e22;"></span> ğŸŸ  ê¸°ì´ˆìˆ˜ê¸‰ ë°€ì§‘ (ë™)</div>
                <div class="legend-item"><span class="dot" style="background:rgba(52, 152, 219, 0.4); border:1px solid #3498db;"></span> ğŸ”µ ì‰¼í„° ì»¤ë²„ë¦¬ì§€</div>
            </div>

            <select class="district-select" onchange="moveDistrict(this.value)">
                <option value="seoul">ğŸ“ ì„œìš¸ì‹œ ì „ì²´</option>
                <option disabled>â”€â”€ ì§‘ì¤‘ ê´€ë¦¬êµ¬ â”€â”€</option>
                <option value="nowon">ë…¸ì›êµ¬ (ìƒì„¸)</option>
                <option value="gangseo">ê°•ì„œêµ¬ (ìƒì„¸)</option>
                <option value="gwanak">ê´€ì•…êµ¬ (ìƒì„¸)</option>
                <option value="eunpyeong">ì€í‰êµ¬ (ìƒì„¸)</option>
                <option value="jungnang">ì¤‘ë‘êµ¬ (ìƒì„¸)</option>
                <option disabled>â”€â”€ ê¸°íƒ€ ìì¹˜êµ¬ â”€â”€</option>
                <option value="gangnam">ê°•ë‚¨êµ¬</option>
                <option value="songpa">ì†¡íŒŒêµ¬</option>
                <option value="jongno">ì¢…ë¡œêµ¬</option>
            </select>
            
            <div class="filter-group">
                <button class="filter-btn active" onclick="filterShelter('all', this)">ì „ì²´ ì‰¼í„°</button>
                <button class="filter-btn" onclick="filterShelter('senior', this)">ğŸ‘´ ê²½ë¡œë‹¹</button>
                <button class="filter-btn" onclick="filterShelter('public', this)">ğŸ¢ ëˆ„êµ¬ë‚˜</button>
            </div>

            <div class="filter-group">
                <button class="filter-btn vul-btn elderly" onclick="toggleLayer('elderly', this)">ğŸ”´ ê³ ë ¹ì ON</button>
                <button class="filter-btn vul-btn poverty" onclick="toggleLayer('poverty', this)">ğŸŸ  ì·¨ì•½ê³„ì¸µ ON</button>
            </div>

            <button class="gps-btn" onclick="findMyLocation()">ğŸ“ ë‚´ ì£¼ë³€ ì°¾ê¸°</button>
            <p id="status-msg" style="margin-top:10px; font-size:13px; font-weight:600;">ë°ì´í„° ë¡œë”© ì¤‘...</p>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // ì¢Œí‘œ ë°ì´í„°
        const districtCoords = {
            "seoul": [37.5665, 126.9780], "gangnam": [37.5172, 127.0473], 
            "nowon": [37.6542, 127.0568], "gangseo": [37.5509, 126.8497], 
            "gwanak": [37.4784, 126.9516], "eunpyeong": [37.6027, 126.9291], 
            "jungnang": [37.6066, 127.0927], "songpa": [37.5145, 127.1066], "jongno": [37.5730, 126.9794]
        };

        var map = L.map('map', { preferCanvas: true }).setView([37.5665, 126.9780], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

        var markers = L.markerClusterGroup();
        var circles = L.layerGroup();
        var elderlyLayer = L.layerGroup(); 
        var povertyLayer = L.layerGroup();

        var allShelterData = [];
        
        // ë°ì´í„° ê²½ë¡œ (ì‰¼í„° + ìƒˆë¡œ ë§Œë“  ë™ë³„ ë°ì´í„°)
        var shelterUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/shelter_data.csv";
        var dongVulUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/dong_data_full.csv";

        // 1. ì‰¼í„° ë°ì´í„° ë¡œë”©
        Papa.parse(shelterUrl, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
            complete: function(results) {
                allShelterData = results.data;
                renderShelters('all');

                // 2. ë™ë³„ ì·¨ì•½ê³„ì¸µ ë°ì´í„° ë¡œë”©
                Papa.parse(dongVulUrl, {
                    download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
                    complete: function(vulResults) {
                        prepareDongLayers(vulResults.data);
                    },
                    error: function() { console.log("ë™ë³„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"); }
                });
            }
        });

        function renderShelters(category) {
            markers.clearLayers();
            circles.clearLayers();
            var count = 0;
            allShelterData.forEach(function(row) {
                var lat = row['ìœ„ë„'] || row['WGS84ìœ„ë„'];
                var lng = row['ê²½ë„'] || row['WGS84ê²½ë„'];
                var name = row['ì‰¼í„°ëª…ì¹­'] || row['ì‰¼í„°ëª…'] || "";
                if (lat && lng) {
                    var isSenior = name.includes("ê²½ë¡œë‹¹") || name.includes("ë…¸ì¸");
                    var show = (category === 'all') || (category === 'senior' && isSenior) || (category === 'public' && !isSenior);
                    if (show) {
                        markers.addLayer(L.marker([lat, lng]).bindPopup(`<b>${name}</b>`));
                        L.circle([lat, lng], { color: 'transparent', fillColor: '#3498db', fillOpacity: 0.08, radius: 500 }).addTo(circles);
                        count++;
                    }
                }
            });
            circles.addTo(map);
            map.addLayer(markers);
            document.getElementById('status-msg').innerText = `ì´ ${count}ê³³ ìš´ì˜ ì¤‘`;
        }

        // â˜… ë™ë³„ ë°ì´í„° ì‹œê°í™” (ì¢Œí‘œ ìˆëŠ” ê²ƒë§Œ í‘œì‹œ)
        function prepareDongLayers(data) {
            data.forEach(function(row) {
                if (row.lat && row.lng) {
                    // ë™ ë‹¨ìœ„ì´ë¯€ë¡œ ì› í¬ê¸°ë¥¼ êµ¬ ë‹¨ìœ„ë³´ë‹¤ ì‘ê²Œ ì„¤ì •
                    if (row.elderly) {
                        var radius1 = Math.sqrt(row.elderly) * 3.5; 
                        L.circle([row.lat, row.lng], {
                            color: '#c0392b', fillColor: '#e74c3c', fillOpacity: 0.3, weight: 1, radius: radius1
                        }).bindPopup(`<b>ğŸš¨ ${row.region} ${row.dong}</b><br>ê³ ë ¹ì: ${Number(row.elderly).toLocaleString()}ëª…`).addTo(elderlyLayer);
                    }
                    if (row.poverty) {
                        var radius2 = Math.sqrt(row.poverty) * 6; 
                        L.circle([row.lat, row.lng], {
                            color: '#d35400', fillColor: '#e67e22', fillOpacity: 0.4, weight: 1, radius: radius2
                        }).bindPopup(`<b>âš ï¸ ${row.region} ${row.dong}</b><br>ìˆ˜ê¸‰ì: ${Number(row.poverty).toLocaleString()}ëª…`).addTo(povertyLayer);
                    }
                }
            });
        }

        function toggleLayer(type, btn) {
            var layer = (type === 'elderly') ? elderlyLayer : povertyLayer;
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
                btn.classList.remove('active');
            } else {
                map.addLayer(layer);
                btn.classList.add('active');
            }
        }

        function filterShelter(category, btnElement) {
            btnElement.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            renderShelters(category);
        }

        function moveDistrict(districtName) {
            var coords = districtCoords[districtName];
            if(coords) map.flyTo(coords, (districtName === 'seoul') ? 12 : 14, { duration: 1.5 });
        }

        function findMyLocation() {
            if (!navigator.geolocation) { alert("ìœ„ì¹˜ ê¸°ëŠ¥ ë¯¸ì§€ì›"); return; }
            navigator.geolocation.getCurrentPosition(pos => {
                map.flyTo([pos.coords.latitude, pos.coords.longitude], 16);
                L.circleMarker([pos.coords.latitude, pos.coords.longitude], { radius: 10, fillColor: "#ff4757", color: "#fff", fillOpacity: 1 }).addTo(map);
            });
        }
        function toggleFullScreen() {
            var elem = document.getElementById('map-wrapper');
            if (!document.fullscreenElement) elem.requestFullscreen().catch(err => alert(err));
            else document.exitFullscreen();
        }
    </script>
</body>
</html>
