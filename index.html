<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì§€êµ¬ë³¸ - ë¬´ë”ìœ„ ì‰¼í„° ëª¨ë‹ˆí„°ë§</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { width: 100%; height: 100%; }
        
        /* ì •ë³´ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .info-box {
            position: absolute; top: 10px; left: 60px; z-index: 1000;
            background: white; padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: center; min-width: 220px;
        }
        h2 { margin: 0 0 5px 0; font-size: 18px; color: #2c3e50; font-weight: 800; }
        .date-text { margin: 0 0 15px 0; font-size: 12px; color: #888; }
        
        /* ë²”ë¡€ ìŠ¤íƒ€ì¼ */
        .legend-box {
            background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px;
            font-size: 12px; text-align: left;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        
        /* â˜… ë‚´ ìœ„ì¹˜ ì°¾ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .gps-btn {
            background: #2c3e50; color: white; border: none;
            padding: 10px 20px; border-radius: 30px;
            font-size: 14px; font-weight: bold; cursor: pointer;
            width: 100%; transition: background 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .gps-btn:hover { background: #1a252f; }
        .gps-btn:active { transform: scale(0.98); }
    </style>
</head>
<body>

    <div class="info-box">
        <h2>ğŸŒ ì„œìš¸ì‹œ ë¬´ë”ìœ„ ì‰¼í„°</h2>
        <p class="date-text">(2025-12-30 ê¸°ì¤€)</p>
        
        <div class="legend-box">
            <div class="legend-item">
                <span class="dot" style="background:#2ecc71;"></span> 
                <span>ğŸŸ¢ ì‰¼í„° (ìš´ì˜ ì¤‘)</span>
            </div>
            <div class="legend-item">
                <span class="dot" style="background:rgba(52, 152, 219, 0.4);"></span> 
                <span>ğŸ”µ ë°˜ê²½ 500m (ì ‘ê·¼ì„±)</span>
            </div>
        </div>

        <p id="status-msg" style="margin:0 0 15px 0; font-size:13px; font-weight:600; color:#333;">
            ë°ì´í„° ë¶„ì„ ì¤‘...
        </p>

        <button class="gps-btn" onclick="findMyLocation()">
            ğŸ“ ë‚´ ì£¼ë³€ ì‰¼í„° ì°¾ê¸°
        </button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // 1. ì§€ë„ ìƒì„± (ì„œìš¸ í™•ëŒ€)
        var map = L.map('map', { preferCanvas: true }).setView([37.5665, 126.9780], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        var markers = L.markerClusterGroup();
        var circles = L.layerGroup();
        var userMarker = null; // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ë¥¼ ë‹´ì„ ë³€ìˆ˜

        // 2. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        var csvUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/shelter_data.csv";

        Papa.parse(csvUrl, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
            complete: function(results) {
                var data = results.data;
                var count = 0;
                
                data.forEach(function(row) {
                    var lat = row['ìœ„ë„'] || row['WGS84ìœ„ë„'];
                    var lng = row['ê²½ë„'] || row['WGS84ê²½ë„'];
                    var name = row['ì‰¼í„°ëª…ì¹­'] || row['ì‰¼í„°ëª…'] || "ì´ë¦„ì—†ìŒ";
                    var address = row['ë„ë¡œëª…ì£¼ì†Œ'] || "";

                    if (lat && lng) {
                        // ì‰¼í„° ë§ˆì»¤ (ì´ˆë¡ìƒ‰ í…Œë§ˆ)
                        var marker = L.marker([lat, lng])
                                      .bindPopup(`<b>${name}</b><br>${address}`);
                        markers.addLayer(marker);
                        
                        // ë°˜ê²½ 500m ì›
                        L.circle([lat, lng], {
                            color: 'transparent', fillColor: '#3498db', fillOpacity: 0.08, radius: 500
                        }).addTo(circles);
                        count++;
                    }
                });

                circles.addTo(map);
                map.addLayer(markers);
                
                if (count > 0) document.getElementById('status-msg').innerText = `ì´ ${count}ê³³ ìš´ì˜ ì¤‘`;
            },
            error: function() { alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"); }
        });

        // â˜… 3. ë‚´ ìœ„ì¹˜ ì°¾ê¸° ê¸°ëŠ¥ í•¨ìˆ˜
        function findMyLocation() {
            if (!navigator.geolocation) {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ (ë¡œë”© ì¤‘ ëŠë‚Œ)
            var btn = document.querySelector('.gps-btn');
            var originalText = btn.innerHTML;
            btn.innerHTML = "ğŸ“¡ ìœ„ì¹˜ íƒìƒ‰ ì¤‘...";

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;

                    // 1) ì§€ë„ë¥¼ ë‚´ ìœ„ì¹˜ë¡œ ì´ë™ (ë¶€ë“œëŸ½ê²Œ ë‚ ì•„ê°€ê¸°)
                    map.flyTo([lat, lng], 16);

                    // 2) ê¸°ì¡´ ë‚´ ìœ„ì¹˜ ë§ˆì»¤ê°€ ìˆë‹¤ë©´ ì§€ì›€
                    if (userMarker) map.removeLayer(userMarker);

                    // 3) ë‚´ ìœ„ì¹˜ì— 'ë¹¨ê°„ìƒ‰ ì›' í‘œì‹œ
                    userMarker = L.circleMarker([lat, lng], {
                        radius: 10,
                        fillColor: "#ff4757", // ë¹¨ê°„ìƒ‰
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 1
                    }).addTo(map).bindPopup("<b>ğŸš© í˜„ì¬ ê³„ì‹  ê³³</b>").openPopup();

                    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì›ìƒë³µêµ¬
                    btn.innerHTML = originalText;
                },
                function() {
                    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì €ì˜ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
                    btn.innerHTML = originalText;
                }
            );
        }
    </script>
</body>
</html>
