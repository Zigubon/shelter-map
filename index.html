<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì§€êµ¬ë³¸ - ìŠ¤ë§ˆíŠ¸ ë³µì§€ ì§€ë„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        #map-wrapper { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; }

        .info-box {
            position: absolute; top: 10px; left: 60px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 260px;
            backdrop-filter: blur(5px);
        }
        h2 { margin: 0 0 5px 0; font-size: 18px; color: #2c3e50; font-weight: 800; text-align: center; }
        
        /* ë²”ë¡€ ìŠ¤íƒ€ì¼ */
        .legend-gradient {
            height: 10px; width: 100%;
            background: linear-gradient(to right, #ffeaa7, #d35400);
            border-radius: 5px; margin: 5px 0;
        }
        .legend-labels { display: flex; justify-content: space-between; font-size: 11px; color: #666; }

        .layer-btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .layer-btn {
            flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 8px;
            background: white; font-size: 13px; font-weight: bold; cursor: pointer;
        }
        .layer-btn.active.elderly { background: #e74c3c; color: white; border-color: #e74c3c; }
        .layer-btn.active.poverty { background: #e67e22; color: white; border-color: #e67e22; }

        .district-select { width: 100%; padding: 8px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; font-weight: bold; }
        .fullscreen-btn { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; border: 0; width: 40px; height: 40px; border-radius: 8px; font-size: 20px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="map-wrapper">
        <button class="fullscreen-btn" onclick="toggleFullScreen()">â›¶</button>

        <div class="info-box">
            <h2>ì„œìš¸ì‹œ ë³µì§€ ì§€ë„ (ë‹¨ê³„êµ¬ë¶„ë„)</h2>
            <p style="font-size:11px; text-align:center; color:#666; margin-bottom:15px;">
                2026-01-01 ê¸°ì¤€ ë°ì´í„° ë¶„ì„
            </p>

            <div style="font-size:12px; font-weight:bold; color:#333;">ë¶„ì„ ì£¼ì œ ì„ íƒ:</div>
            <div class="layer-btn-group">
                <button class="layer-btn active elderly" onclick="setMode('elderly')">ğŸ”´ ê³ ë ¹ì</button>
                <button class="layer-btn poverty" onclick="setMode('poverty')">ğŸŸ  ì·¨ì•½ê³„ì¸µ</button>
            </div>

            <div style="margin-top:15px;">
                <div style="font-size:12px; font-weight:bold; color:#333;">ì¸êµ¬ ë°€ì§‘ë„:</div>
                <div class="legend-gradient" id="legend-bar"></div>
                <div class="legend-labels">
                    <span>ì ìŒ</span>
                    <span>ë§ìŒ</span>
                </div>
            </div>

            <select class="district-select" onchange="moveDistrict(this.value)">
                <option value="seoul">ğŸ“ ì„œìš¸ì‹œ ì „ì²´ ë³´ê¸°</option>
                <option value="nowon">ë…¸ì›êµ¬</option>
                <option value="gangseo">ê°•ì„œêµ¬</option>
                <option value="gwanak">ê´€ì•…êµ¬</option>
                <option value="eunpyeong">ì€í‰êµ¬</option>
                <option value="jungnang">ì¤‘ë‘êµ¬</option>
                <option value="gangnam">ê°•ë‚¨êµ¬</option>
                <option value="songpa">ì†¡íŒŒêµ¬</option>
            </select>
            
            <p id="status-msg" style="margin-top:10px; font-size:12px; color:#555; text-align:center;">ì§€ë„ ë°ì´í„° ë¡œë”© ì¤‘...</p>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        // ì„œìš¸ì‹œ ì¤‘ì‹¬
        var map = L.map('map', { preferCanvas: true }).setView([37.5665, 126.9780], 11);
        
        // ë°°ê²½ ì§€ë„ (ê¹”ë”í•œ íšŒìƒ‰í†¤ - CartoDB Positron)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);

        var geojsonLayer;
        var dongData = {}; // CSV ë°ì´í„°ë¥¼ ë‹´ì„ ê°ì²´
        var currentMode = 'elderly'; // 'elderly' or 'poverty'

        // ë°ì´í„° URL
        var csvUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/seoul_dong_data.csv";
        var geojsonUrl = "https://raw.githubusercontent.com/southkorea/seoul-maps/master/kostat/2013/json/seoul_dong.geojson";

        // 1. CSV ë°ì´í„° ë¡œë”©
        Papa.parse(csvUrl, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
            complete: function(results) {
                // CSV ë°ì´í„°ë¥¼ ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜ (Key: ë™ ì´ë¦„)
                results.data.forEach(row => {
                    // êµ¬ ì´ë¦„ + ë™ ì´ë¦„ ì¡°í•©ìœ¼ë¡œ ë§¤ì¹­ (ì˜ˆ: "ì¢…ë¡œêµ¬ ì‚¬ì§ë™")
                    var key = row.full_name; 
                    if (!key && row.gu && row.dong) key = row.gu + " " + row.dong;
                    if (key) {
                        dongData[key] = row;
                        // ë™ ì´ë¦„ë§Œìœ¼ë¡œë„ fallback ì €ì¥ (GeoJSONì— êµ¬ ì •ë³´ê°€ ì—†ì„ ê²½ìš° ëŒ€ë¹„)
                        if (!dongData[row.dong]) dongData[row.dong] = row;
                    }
                });
                console.log("CSV ë°ì´í„° ë¡œë”© ì™„ë£Œ: " + Object.keys(dongData).length + "ê°œ");
                
                // 2. GeoJSON ë¡œë”© ë° ì§€ë„ ê·¸ë¦¬ê¸°
                loadGeoJSON();
            }
        });

        function loadGeoJSON() {
            fetch(geojsonUrl)
                .then(response => response.json())
                .then(data => {
                    geojsonLayer = L.geoJson(data, {
                        style: styleFeature,
                        onEachFeature: onEachFeature
                    }).addTo(map);
                    document.getElementById('status-msg').innerText = "ë°ì´í„° ì‹œê°í™” ì™„ë£Œ";
                });
        }

        // ìŠ¤íƒ€ì¼ í•¨ìˆ˜ (ìƒ‰ê¹” ì…íˆê¸°)
        function styleFeature(feature) {
            var dongName = feature.properties.name; // GeoJSONì˜ ë™ ì´ë¦„
            var data = dongData[dongName]; // ì´ë¦„ìœ¼ë¡œ ë°ì´í„° ì°¾ê¸°
            
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ íšŒìƒ‰
            var value = 0;
            if (data) {
                value = (currentMode === 'elderly') ? data.elderly : data.poverty;
            }

            return {
                fillColor: getColor(value),
                weight: 1,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        // ìƒ‰ìƒ ìŠ¤ì¼€ì¼ (ê°’ì— ë”°ë¼ ìƒ‰ ê²°ì •)
        function getColor(d) {
            if (currentMode === 'elderly') {
                // ê³ ë ¹ì ìƒ‰ìƒ (Red scale) - ìµœëŒ€ 1ë§Œëª… ê¸°ì¤€
                return d > 8000 ? '#800026' :
                       d > 6000 ? '#BD0026' :
                       d > 4000 ? '#E31A1C' :
                       d > 2000 ? '#FC4E2A' :
                       d > 1000 ? '#FD8D3C' :
                       d > 0    ? '#FEB24C' : '#FFEDA0';
            } else {
                // ì·¨ì•½ê³„ì¸µ ìƒ‰ìƒ (Orange/Brown scale) - ìµœëŒ€ 3ì²œëª… ê¸°ì¤€
                return d > 2500 ? '#7f2704' :
                       d > 2000 ? '#a63603' :
                       d > 1500 ? '#d94801' :
                       d > 1000 ? '#f16913' :
                       d > 500  ? '#fd8d3c' :
                       d > 0    ? '#fdae6b' : '#feedde';
            }
        }

        // ìƒí˜¸ì‘ìš© (ë§ˆìš°ìŠ¤ ì˜¤ë²„ ë“±)
        function onEachFeature(feature, layer) {
            var dongName = feature.properties.name;
            var data = dongData[dongName] || { elderly: 'ì •ë³´ì—†ìŒ', poverty: 'ì •ë³´ì—†ìŒ' };
            
            // íŒì—… ë‚´ìš©
            var popupContent = `
                <div style="text-align:center; min-width:120px;">
                    <h3 style="margin:0 0 5px 0; color:#333;">${dongName}</h3>
                    <div style="font-size:13px;">
                        ğŸ”´ ê³ ë ¹ì: <b>${Number(data.elderly).toLocaleString()}ëª…</b><br>
                        ğŸŸ  ìˆ˜ê¸‰ì: <b>${Number(data.poverty).toLocaleString()}ëª…</b>
                    </div>
                </div>
            `;
            layer.bindPopup(popupContent);
            
            // í˜¸ë²„ íš¨ê³¼
            layer.on({
                mouseover: function(e) {
                    var layer = e.target;
                    layer.setStyle({ weight: 3, color: '#666', dashArray: '', fillOpacity: 0.9 });
                    layer.openPopup();
                },
                mouseout: function(e) {
                    geojsonLayer.resetStyle(e.target);
                    layer.closePopup();
                }
            });
        }

        // ëª¨ë“œ ë³€ê²½ í•¨ìˆ˜
        function setMode(mode) {
            currentMode = mode;
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
            document.querySelectorAll('.layer-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.layer-btn.' + mode).classList.add('active');
            
            // ë²”ë¡€ ìƒ‰ìƒ ë³€ê²½
            var bar = document.getElementById('legend-bar');
            if(mode === 'elderly') bar.style.background = 'linear-gradient(to right, #FFEDA0, #800026)';
            else bar.style.background = 'linear-gradient(to right, #feedde, #7f2704)';

            // ì§€ë„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            geojsonLayer.setStyle(styleFeature);
        }

        // ìì¹˜êµ¬ ì´ë™
        const districtCoords = {
            "seoul": [37.5665, 126.9780], "nowon": [37.6542, 127.0568], "gangseo": [37.5509, 126.8497],
            "gwanak": [37.4784, 126.9516], "eunpyeong": [37.6027, 126.9291], "jungnang": [37.6066, 127.0927],
            "gangnam": [37.5172, 127.0473], "songpa": [37.5145, 127.1066]
        };
        function moveDistrict(val) {
            var coords = districtCoords[val];
            if(coords) map.flyTo(coords, val === 'seoul' ? 11 : 13);
        }
        function toggleFullScreen() {
            var el = document.getElementById('map-wrapper');
            if(!document.fullscreenElement) el.requestFullscreen().catch(e=>alert(e));
            else document.exitFullscreen();
        }
    </script>
</body>
</html>
