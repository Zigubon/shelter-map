<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì„œìš¸ ë¬´ë”ìœ„ ì‰¼í„° ëª¨ë‹ˆí„°ë§</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        #map-wrapper { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; background: #f8f9fa; }

        /* ì •ë³´ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .info-box {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            width: 250px;
            font-size: 13px;
            max-height: 90vh; overflow-y: auto; /* í™”ë©´ ì‘ì„ ë•Œ ìŠ¤í¬ë¡¤ */
        }
        h2 { margin: 0 0 10px 0; font-size: 16px; text-align: center; color: #2c3e50; font-weight: 800; letter-spacing: -0.5px; }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .mode-btn, .filter-btn {
            flex: 1; padding: 8px 0; border: 1px solid #ddd; border-radius: 6px;
            background: white; font-size: 11px; font-weight: bold; cursor: pointer;
            text-align: center; transition: all 0.2s;
        }
        .mode-btn.active.elderly { background: #800026; color: white; border-color: #800026; }
        .mode-btn.active.poverty { background: #7f2704; color: white; border-color: #7f2704; }
        .filter-btn.active { background: #3498db; color: white; border-color: #3498db; }
        
        /* ìƒì„¸ ë²”ë¡€ ìŠ¤íƒ€ì¼ */
        .legend-container {
            background: #f1f3f5; padding: 10px; border-radius: 8px; margin-bottom: 15px;
        }
        .legend-title { font-weight: bold; margin-bottom: 5px; font-size: 11px; color: #555; }
        .legend-item { display: flex; align-items: center; margin-bottom: 3px; font-size: 11px; }
        .legend-color { width: 12px; height: 12px; display: inline-block; margin-right: 8px; border: 1px solid #ccc; }

        /* ì‰¼í„° ë²”ë¡€ */
        .shelter-legend { margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; }
        .circle-sample {
            width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px;
            background: rgba(52, 152, 219, 0.2); border: 1px solid #3498db;
        }

        /* ë¡œë”© ëª¨ë‹ˆí„° */
        .debug-box {
            position: absolute; bottom: 5px; left: 5px; z-index: 2000;
            background: rgba(0,0,0,0.7); color: #fff; padding: 5px 10px;
            border-radius: 4px; font-size: 10px; font-family: monospace;
            pointer-events: none;
        }

        .fullscreen-btn { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; border: 0; width: 36px; height: 36px; border-radius: 8px; font-size: 18px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="map-wrapper">
        <button class="fullscreen-btn" onclick="toggleFullScreen()">â›¶</button>
        
        <div class="info-box">
            <h2>ì„œìš¸ ë¬´ë”ìœ„ ì‰¼í„° ëª¨ë‹ˆí„°ë§</h2>
            
            <div style="font-weight:bold; margin-bottom:5px; color:#333;">ğŸ“Š ì¸êµ¬ ë°€ì§‘ë„ ë¶„ì„</div>
            <div class="btn-group">
                <button class="mode-btn active elderly" onclick="setMode('elderly')">ğŸ”´ ê³ ë ¹ì</button>
                <button class="mode-btn poverty" onclick="setMode('poverty')">ğŸŸ  ì·¨ì•½ê³„ì¸µ</button>
            </div>
            
            <div class="legend-container" id="dynamic-legend">
                </div>

            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">

            <div style="font-weight:bold; margin-bottom:5px; color:#333;">â›±ï¸ ì‰¼í„° í˜„í™©</div>
            <div class="btn-group">
                <button class="filter-btn active" onclick="filterShelter('all', this)">ì „ì²´</button>
                <button class="filter-btn" onclick="filterShelter('senior', this)">ê²½ë¡œë‹¹</button>
                <button class="filter-btn" onclick="filterShelter('public', this)">ëˆ„êµ¬ë‚˜</button>
            </div>
            
            <div class="legend-item shelter-legend">
                <span class="circle-sample"></span>
                <span>ì ‘ê·¼ì„± ë°˜ê²½ (300m)</span>
            </div>
        </div>

        <div class="debug-box" id="debug-msg">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        // --- 1. ì§€ë„ ì´ˆê¸°í™” ---
        var map = L.map('map', { zoomControl: false }).setView([37.5665, 126.9780], 11);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© OpenStreetMap, Â© CARTO'
        }).addTo(map);

        // --- 2. ë³€ìˆ˜ ì„ ì–¸ ---
        var geojsonLayer;
        var markerCluster = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
        var circleGroup = L.layerGroup().addTo(map); // 300m ë°˜ê²½ ì›ë“¤ì„ ë‹´ì„ ê·¸ë£¹
        
        var dongData = {};
        var shelterData = [];
        var currentMode = 'elderly';

        // --- 3. íŒŒì¼ ê²½ë¡œ ---
        var URL_DONG_CSV = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/seoul_dong_data.csv";
        var URL_GEOJSON = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/seoul_dong.geojson";
        var URL_SHELTER = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/shelter_data.csv";

        // --- 4. ë¡œê¹… ---
        function log(msg) {
            console.log(msg);
            document.getElementById('debug-msg').innerText = msg;
        }

        // --- 5. ë°ì´í„° ë¡œë”© íŒŒì´í”„ë¼ì¸ ---
        log("1. ë™ë³„ ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘...");
        
        Papa.parse(URL_DONG_CSV, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
            complete: function(results) {
                results.data.forEach(row => {
                    var cleanName = normalizeName(row.full_name || row.dong);
                    if(cleanName) dongData[cleanName] = row;
                });
                log(`1. ë°ì´í„° ${Object.keys(dongData).length}ê°œ ì™„ë£Œ. ì§€ë„ íŒŒì¼ ë¡œë”©...`);
                loadGeoJSON();
            },
            error: function() { log("âŒ ë™ë³„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨!"); }
        });

        function loadGeoJSON() {
            fetch(URL_GEOJSON)
                .then(res => res.json())
                .then(data => {
                    geojsonLayer = L.geoJson(data, {
                        style: styleFeature,
                        onEachFeature: onEachFeature
                    }).addTo(map);
                    log("2. ì§€ë„ ìƒì„± ì™„ë£Œ. ì‰¼í„° í•€ ë¡œë”©...");
                    loadShelters();
                })
                .catch(err => log("âŒ ì§€ë„ íŒŒì¼(GeoJSON) ë¡œë”© ì‹¤íŒ¨!"));
        }

        function loadShelters() {
            Papa.parse(URL_SHELTER, {
                download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
                complete: function(results) {
                    shelterData = results.data;
                    renderShelters('all');
                    setMode('elderly'); // ì´ˆê¸° ëª¨ë“œ ë° ë²”ë¡€ ìƒì„±
                    log("âœ… ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘");
                    setTimeout(() => { document.getElementById('debug-msg').style.display = 'none'; }, 3000);
                },
                error: function() { log("âŒ ì‰¼í„° ë°ì´í„° ë¡œë”© ì‹¤íŒ¨!"); }
            });
        }

        // --- 6. í•µì‹¬ ê¸°ëŠ¥ë“¤ ---

        function normalizeName(name) {
            if (!name) return "";
            return name.replace(/Â·/g, ".").replace(/\s+/g, "").trim(); 
        }

        function getDataByFeature(feature) {
            var rawName = feature.properties.adm_nm || feature.properties.name || "";
            var simpleName = rawName.split(" ").slice(1).join("");
            var key = normalizeName(rawName); 
            
            if(dongData[key]) return dongData[key];
            if(dongData[simpleName]) return dongData[simpleName];

            const mapTable = { 
                "ê°•ë‚¨êµ¬ì¼ì›2ë™": "ê°•ë‚¨êµ¬ê°œí¬3ë™", "ê°•ë™êµ¬ìƒì¼ë™": "ê°•ë™êµ¬ìƒì¼1ë™",
                "ë…¸ì›êµ¬ì¤‘ê³„2.3ë™": "ë…¸ì›êµ¬ì¤‘ê³„2.3ë™", "ì¢…ë¡œêµ¬ì¢…ë¡œ1.2.3.4ê°€ë™": "ì¢…ë¡œêµ¬ì¢…ë¡œ1.2.3.4ê°€ë™"
            };
            var shortKey = normalizeName(feature.properties.sggnm + feature.properties.adm_nm.split(" ").pop());
            if(mapTable[shortKey] && dongData[normalizeName(mapTable[shortKey])]) return dongData[normalizeName(mapTable[shortKey])];

            return { elderly: 0, poverty: 0 };
        }

        // [ê¸°ëŠ¥ 1] ë™ì  ë²”ë¡€ ìƒì„± (Dynamic Legend)
        function updateLegend() {
            var container = document.getElementById('dynamic-legend');
            var grades, colors, labelText;

            if (currentMode === 'elderly') {
                grades = [8000, 6000, 4000, 2000, 0];
                colors = ['#800026', '#BD0026', '#E31A1C', '#FC4E2A', '#FFEDA0']; // ë¹¨ê°• ê³„ì—´
                labelText = "ê³ ë ¹ ì¸êµ¬ìˆ˜ (ëª…)";
            } else {
                grades = [2500, 2000, 1500, 1000, 0];
                colors = ['#7f2704', '#a63603', '#d94801', '#f16913', '#feedde']; // ì£¼í™© ê³„ì—´
                labelText = "ìˆ˜ê¸‰ì ì¸êµ¬ìˆ˜ (ëª…)";
            }

            var html = `<div class="legend-title">${labelText}</div>`;
            for (var i = 0; i < grades.length; i++) {
                var rangeStr = (i === 0) ? `${grades[i].toLocaleString()}ëª… ì´ìƒ` : 
                               `${grades[i].toLocaleString()} ~ ${grades[i-1].toLocaleString()}`;
                html += `
                    <div class="legend-item">
                        <i class="legend-color" style="background:${colors[i]}"></i>
                        <span>${rangeStr}</span>
                    </div>`;
            }
            container.innerHTML = html;
        }

        function styleFeature(feature) {
            var data = getDataByFeature(feature);
            var value = (currentMode === 'elderly') ? data.elderly : data.poverty;
            return { fillColor: getColor(value), weight: 1, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7 };
        }

        function getColor(d) {
            if (currentMode === 'elderly') {
                return d > 8000 ? '#800026' : d > 6000 ? '#BD0026' : d > 4000 ? '#E31A1C' :
                       d > 2000 ? '#FC4E2A' : '#FFEDA0';
            } else {
                return d > 2500 ? '#7f2704' : d > 2000 ? '#a63603' : d > 1500 ? '#d94801' :
                       d > 1000 ? '#f16913' : '#feedde';
            }
        }

        // [ê¸°ëŠ¥ 2] ì‰¼í„° í•€ + ì ‘ê·¼ì„± ë°˜ê²½(300m) ê·¸ë¦¬ê¸°
        function renderShelters(category) {
            markerCluster.clearLayers();
            circleGroup.clearLayers(); // ê¸°ì¡´ ì› ì‚­ì œ

            shelterData.forEach(row => {
                var lat = row['ìœ„ë„'] || row['WGS84ìœ„ë„'];
                var lng = row['ê²½ë„'] || row['WGS84ê²½ë„'];
                var name = row['ì‰¼í„°ëª…ì¹­'] || row['ì‰¼í„°ëª…'] || "";
                
                if (lat && lng) {
                    var isSenior = name.includes("ê²½ë¡œë‹¹") || name.includes("ë…¸ì¸");
                    var show = (category === 'all') || (category === 'senior' && isSenior) || (category === 'public' && !isSenior);
                    
                    if (show) {
                        // 1. í•€ ì¶”ê°€
                        var marker = L.marker([lat, lng]);
                        marker.bindPopup(`<b>${name}</b>`);
                        markerCluster.addLayer(marker);

                        // 2. ì ‘ê·¼ì„± ë°˜ê²½(300m) ì› ì¶”ê°€
                        L.circle([lat, lng], {
                            radius: 300, // 300ë¯¸í„°
                            color: 'transparent', // í…Œë‘ë¦¬ ì—†ìŒ
                            fillColor: '#3498db', // íŒŒë€ìƒ‰
                            fillOpacity: 0.15,    // íˆ¬ëª…ë„
                            interactive: false    // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¬´ì‹œ (ì§€ë„ í´ë¦­ ë°©í•´ ì•ˆ í•¨)
                        }).addTo(circleGroup);
                    }
                }
            });
            map.addLayer(markerCluster);
        }

        function filterShelter(category, btnElement) {
            var group = btnElement.parentElement;
            group.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            renderShelters(category);
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.mode-btn.' + mode).classList.add('active');
            
            updateLegend(); // ë²”ë¡€ ì—…ë°ì´íŠ¸
            if(geojsonLayer) geojsonLayer.setStyle(styleFeature);
        }

        function onEachFeature(feature, layer) {
            var data = getDataByFeature(feature);
            var shortName = feature.properties.adm_nm ? feature.properties.adm_nm.split(" ").pop() : feature.properties.name;
            layer.bindPopup(`<div style="text-align:center;"><b>${shortName}</b><hr style="margin:5px 0;">ğŸ”´ ê³ ë ¹ì: ${Number(data.elderly).toLocaleString()}ëª…<br>ğŸŸ  ìˆ˜ê¸‰ì: ${Number(data.poverty).toLocaleString()}ëª…</div>`, { className: 'custom-popup' });
            layer.on({
                mouseover: function(e) { e.target.setStyle({ weight: 3, color: '#333', fillOpacity: 0.9 }); },
                mouseout: function(e) { geojsonLayer.resetStyle(e.target); }
            });
        }

        function toggleFullScreen() {
            var el = document.getElementById('map-wrapper');
            if(!document.fullscreenElement) el.requestFullscreen(); else document.exitFullscreen();
        }
    </script>
</body>
</html>
