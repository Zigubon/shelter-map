<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì§€êµ¬ë³¸ - ë¬´ë”ìœ„ ì‰¼í„° ëª¨ë‹ˆí„°ë§</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { width: 100%; height: 100%; }
        
        /* ì •ë³´ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .info-box {
            position: absolute; top: 10px; left: 60px; z-index: 1000;
            background: white; padding: 15px 20px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            text-align: center; min-width: 200px;
        }
        h2 { margin: 0; font-size: 18px; color: #2c3e50; font-weight: bold; }
        .date-text { margin: 4px 0 8px 0; font-size: 12px; color: #888; }
        .legend-text { font-size: 12px; color: #3498db; margin-top: 5px; font-weight: 600; }
    </style>
</head>
<body>

    <div class="info-box">
        <h2>ğŸŒ ì„œìš¸ì‹œ ë¬´ë”ìœ„ ì‰¼í„° ë¶„ì„</h2>
        <p class="date-text">(2025-12-30 ê¸°ì¤€)</p>
        <p id="status-msg" style="margin:0; font-size:13px; font-weight:500;">ë°ì´í„° ë¶„ì„ ì¤‘...</p>
        
        <p class="legend-text">ğŸ”µ ì› = ë°˜ê²½ 500m (ë³´í–‰ ì ‘ê·¼ì„±)</p>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // 1. ì§€ë„ ìƒì„± (ì„œìš¸ í™•ëŒ€ / ì„±ëŠ¥ ìµœì í™” ëª¨ë“œ ì¼œê¸°)
        var map = L.map('map', { preferCanvas: true }).setView([37.5665, 126.9780], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        var markers = L.markerClusterGroup();
        var circles = L.layerGroup(); // ì›(Circle)ì„ ë‹´ì„ ë³„ë„ ë ˆì´ì–´

        // 2. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ë³´ë‚´ì£¼ì‹  ì •í™•í•œ ì£¼ì†Œ ì ìš©)
        var csvUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/shelter_data.csv";

        Papa.parse(csvUrl, {
            download: true,
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            encoding: "UTF-8",
            complete: function(results) {
                var data = results.data;
                var count = 0;
                
                data.forEach(function(row) {
                    var lat = row['ìœ„ë„'] || row['WGS84ìœ„ë„'];
                    var lng = row['ê²½ë„'] || row['WGS84ê²½ë„'];
                    var name = row['ì‰¼í„°ëª…ì¹­'] || row['ì‰¼í„°ëª…'] || "ì´ë¦„ì—†ìŒ";
                    var address = row['ë„ë¡œëª…ì£¼ì†Œ'] || "";

                    if (lat && lng) {
                        // (1) í•€ ìƒì„±
                        var marker = L.marker([lat, lng])
                                      .bindPopup(`<b>${name}</b><br>${address}`);
                        markers.addLayer(marker);
                        
                        // (2) ë°˜ê²½ 500m ì› ê·¸ë¦¬ê¸° (ë¶„ì„ ì‹œê°í™”)
                        L.circle([lat, lng], {
                            color: 'transparent',    // í…Œë‘ë¦¬ ì—†ìŒ
                            fillColor: '#3498db',    // íŒŒë€ìƒ‰ ì±„ìš°ê¸°
                            fillOpacity: 0.08,       // 8% íˆ¬ëª…ë„ (ê²¹ì¹˜ë©´ ì§„í•´ì§)
                            radius: 500              // 500m ë°˜ê²½
                        }).addTo(circles);

                        count++;
                    }
                });

                // ì§€ë„ì— í‘œì‹œ (ì› ë¨¼ì € ê¹”ê³ , ê·¸ ìœ„ì— í•€ ì˜¬ë¦¬ê¸°)
                circles.addTo(map);
                map.addLayer(markers);
                
                if (count > 0) {
                    document.getElementById('status-msg').innerText = `ì´ ${count}ê³³ ë¶„ì„ ì™„ë£Œ`;
                } else {
                    document.getElementById('status-msg').innerText = "ë°ì´í„° ì—†ìŒ";
                }
            },
            error: function(err) {
                console.error(err);
                alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨! ì£¼ì†Œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        });
    </script>
</body>
</html>
