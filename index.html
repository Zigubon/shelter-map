<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì§€êµ¬ë³¸ - ë¬´ë”ìœ„ ì‰¼í„° ëª¨ë‹ˆí„°ë§</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        #map-wrapper { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; }
        
        .info-box {
            position: absolute; top: 10px; left: 60px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: center; min-width: 260px;
            backdrop-filter: blur(5px);
        }
        h2 { margin: 0 0 5px 0; font-size: 18px; color: #2c3e50; font-weight: 800; }
        
        .legend-box {
            background: #f1f3f5; padding: 12px; border-radius: 8px; margin-bottom: 15px;
            font-size: 13px; text-align: left; font-weight: 600;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; }
        .dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; margin-right: 8px; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.2); }

        .district-select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .filter-group { display: flex; gap: 5px; justify-content: center; margin-bottom: 10px; flex-wrap: wrap; }
        .filter-btn { background: #fff; border: 1px solid #dee2e6; color: #495057; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .filter-btn.active { background: #2c3e50; color: white; border-color: #2c3e50; }
        
        .vul-btn.elderly.active { background: #e74c3c; border-color: #e74c3c; color: white; }
        .vul-btn.poverty.active { background: #e67e22; border-color: #e67e22; color: white; }

        .gps-btn { background: #3498db; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; }
        .fullscreen-btn { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; border: none; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 20px; }
    </style>
</head>
<body>

    <div id="map-wrapper">
        <button class="fullscreen-btn" onclick="toggleFullScreen()">â›¶</button>

        <div class="info-box">
            <h2>ğŸŒ ìŠ¤ë§ˆíŠ¸ ì‰¼í„° ì§€ë„ (ë™ë³„ ë¶„ì„)</h2>
            <p style="font-size:11px; color:#666; margin-bottom:10px; line-height:1.4;">
                ğŸ“… 2026-01-01 ê¸°ì¤€<br>
                (ì¢Œí‘œ ìë™ ë³´ì • ê¸°ëŠ¥ íƒ‘ì¬ë¨)
            </p>

            <div class="legend-box">
                <div class="legend-item"><span class="dot" style="background:#e74c3c;"></span> ğŸ”´ ê³ ë ¹ì ë°€ì§‘ (ë™)</div>
                <div class="legend-item"><span class="dot" style="background:#e67e22;"></span> ğŸŸ  ê¸°ì´ˆìˆ˜ê¸‰ ë°€ì§‘ (ë™)</div>
                <div class="legend-item"><span class="dot" style="background:rgba(52, 152, 219, 0.4); border:1px solid #3498db;"></span> ğŸ”µ ì‰¼í„° ì»¤ë²„ë¦¬ì§€</div>
            </div>

            <select class="district-select" onchange="moveDistrict(this.value)">
                <option value="seoul">ğŸ“ ì„œìš¸ì‹œ ì „ì²´</option>
                <option disabled>â”€â”€ ì§‘ì¤‘ ê´€ë¦¬êµ¬ â”€â”€</option>
                <option value="nowon">ë…¸ì›êµ¬ (ìƒì„¸)</option>
                <option value="gangseo">ê°•ì„œêµ¬ (ìƒì„¸)</option>
                <option value="gwanak">ê´€ì•…êµ¬ (ìƒì„¸)</option>
                <option value="eunpyeong">ì€í‰êµ¬ (ìƒì„¸)</option>
                <option value="jungnang">ì¤‘ë‘êµ¬ (ìƒì„¸)</option>
                <option disabled>â”€â”€ ê¸°íƒ€ ìì¹˜êµ¬ â”€â”€</option>
                <option value="gangnam">ê°•ë‚¨êµ¬</option>
                <option value="songpa">ì†¡íŒŒêµ¬</option>
                <option value="jongno">ì¢…ë¡œêµ¬</option>
            </select>
            
            <div class="filter-group">
                <button class="filter-btn active" onclick="filterShelter('all', this)">ì „ì²´ ì‰¼í„°</button>
                <button class="filter-btn" onclick="filterShelter('senior', this)">ğŸ‘´ ê²½ë¡œë‹¹</button>
                <button class="filter-btn" onclick="filterShelter('public', this)">ğŸ¢ ëˆ„êµ¬ë‚˜</button>
            </div>

            <div class="filter-group">
                <button class="filter-btn vul-btn elderly" onclick="toggleLayer('elderly', this)">ğŸ”´ ê³ ë ¹ì ON</button>
                <button class="filter-btn vul-btn poverty" onclick="toggleLayer('poverty', this)">ğŸŸ  ì·¨ì•½ê³„ì¸µ ON</button>
            </div>

            <button class="gps-btn" onclick="findMyLocation()">ğŸ“ ë‚´ ì£¼ë³€ ì°¾ê¸°</button>
            <p id="status-msg" style="margin-top:10px; font-size:13px; font-weight:600;">ë°ì´í„° ë¡œë”© ì¤‘...</p>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // ì¢Œí‘œ ë°ì´í„°
        const districtCoords = {
            "seoul": [37.5665, 126.9780], "gangnam": [37.5172, 127.0473], 
            "nowon": [37.6542, 127.0568], "gangseo": [37.5509, 126.8497], 
            "gwanak": [37.4784, 126.9516], "eunpyeong": [37.6027, 126.9291], 
            "jungnang": [37.6066, 127.0927], "songpa": [37.5145, 127.1066], "jongno": [37.5730, 126.9794]
        };
        
        // â˜… ë¹„ìƒìš© ì¢Œí‘œ ì‚¬ì „ (ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨ ì‹œ ì‚¬ìš©)
        const fallbackCoords = {
            "ê°•ì„œêµ¬ ê°€ì–‘1ë™": [37.5714, 126.8491], "ê°•ì„œêµ¬ ê³µí•­ë™": [37.5552, 126.8170],
            "ê°•ì„œêµ¬ ë“±ì´Œ1ë™": [37.5544, 126.8617], "ê°•ì„œêµ¬ ë“±ì´Œ2ë™": [37.5467, 126.8631],
            "ê°•ì„œêµ¬ ë°œì‚°1ë™": [37.5539, 126.8354], "ê°•ì„œêµ¬ ë°©í™”1ë™": [37.5731, 126.8174],
            "ê°•ì„œêµ¬ ì—¼ì°½ë™": [37.5501, 126.8744], "ê°•ì„œêµ¬ ìš°ì¥ì‚°ë™": [37.5516, 126.8437],
            "ê´€ì•…êµ¬ ë‚™ì„±ëŒ€ë™": [37.4764, 126.9635], "ê´€ì•…êµ¬ ëŒ€í•™ë™": [37.4706, 126.9369],
            "ê´€ì•…êµ¬ ë¯¸ì„±ë™": [37.4761, 126.9168], "ê´€ì•…êµ¬ ë³´ë¼ë§¤ë™": [37.4897, 126.9287],
            "ê´€ì•…êµ¬ ì„œì›ë™": [37.4815, 126.9333], "ê´€ì•…êµ¬ ì‹ ì‚¬ë™": [37.4866, 126.9190],
            "ê´€ì•…êµ¬ ì¡°ì›ë™": [37.4831, 126.9069], "ê´€ì•…êµ¬ ì¤‘ì•™ë™": [37.4801, 126.9511],
            "ë…¸ì›êµ¬ ê³µë¦‰2ë™": [37.6253, 127.0907], "ë…¸ì›êµ¬ ì›”ê³„2ë™": [37.6322, 127.0514],
            "ë…¸ì›êµ¬ ì¤‘ê³„1ë™": [37.6493, 127.0768], "ì€í‰êµ¬ ë…¹ë²ˆë™": [37.6022, 126.9351],
            "ì€í‰êµ¬ ëŒ€ì¡°ë™": [37.6108, 126.9205], "ì€í‰êµ¬ ìˆ˜ìƒ‰ë™": [37.5855, 126.8957],
            "ì€í‰êµ¬ ì‹ ì‚¬1ë™": [37.5991, 126.9126], "ì¤‘ë‘êµ¬ ìƒë´‰1ë™": [37.5968, 127.0933]
        };

        var map = L.map('map', { preferCanvas: true }).setView([37.5665, 126.9780], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

        var markers = L.markerClusterGroup();
        var circles = L.layerGroup();
        var elderlyLayer = L.layerGroup(); 
        var povertyLayer = L.layerGroup();

        var allShelterData = [];
        var shelterUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/shelter_data.csv";
        var dongVulUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/dong_data_full.csv";

        Papa.parse(shelterUrl, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
            complete: function(results) {
                allShelterData = results.data;
                renderShelters('all');

                Papa.parse(dongVulUrl, {
                    download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
                    complete: function(vulResults) {
                        prepareDongLayers(vulResults.data);
                    },
                    error: function() { console.log("ë™ë³„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"); }
                });
            }
        });

        function renderShelters(category) {
            markers.clearLayers();
            circles.clearLayers();
            var count = 0;
            allShelterData.forEach(function(row) {
                var lat = row['ìœ„ë„'] || row['WGS84ìœ„ë„'];
                var lng = row['ê²½ë„'] || row['WGS84ê²½ë„'];
                var name = row['ì‰¼í„°ëª…ì¹­'] || row['ì‰¼í„°ëª…'] || "";
                if (lat && lng) {
                    var isSenior = name.includes("ê²½ë¡œë‹¹") || name.includes("ë…¸ì¸");
                    var show = (category === 'all') || (category === 'senior' && isSenior) || (category === 'public' && !isSenior);
                    if (show) {
                        markers.addLayer(L.marker([lat, lng]).bindPopup(`<b>${name}</b>`));
                        L.circle([lat, lng], { color: 'transparent', fillColor: '#3498db', fillOpacity: 0.08, radius: 500 }).addTo(circles);
                        count++;
                    }
                }
            });
            circles.addTo(map);
            map.addLayer(markers);
            document.getElementById('status-msg').innerText = `ì´ ${count}ê³³ ìš´ì˜ ì¤‘`;
        }

        // â˜… [í•µì‹¬] ì¢Œí‘œê°€ ìˆìœ¼ë©´ ì“°ê³ , ì—†ìœ¼ë©´ ë¹„ìƒìš© ì¢Œí‘œ(fallback)ì—ì„œ ì°¾ì•„ ì“°ëŠ” í•¨ìˆ˜
        function prepareDongLayers(data) {
            var filledCount = 0;
            data.forEach(function(row) {
                var lat = row.lat;
                var lng = row.lng;
                var addressKey = row.region + " " + row.dong; // "ê°•ì„œêµ¬ ê°€ì–‘1ë™"

                // 1. CSVì— ì¢Œí‘œê°€ ë¹„ì–´ìˆë‹¤ë©´? -> ë¹„ìƒìš© ì‚¬ì „ì—ì„œ ì°¾ê¸°
                if (!lat || !lng) {
                    if (fallbackCoords[addressKey]) {
                        lat = fallbackCoords[addressKey][0];
                        lng = fallbackCoords[addressKey][1];
                    }
                }

                // 2. ê·¸ë˜ë„ ì¢Œí‘œê°€ ìˆë‹¤ë©´ ì§€ë„ì— í‘œì‹œ
                if (lat && lng) {
                    if (row.elderly) {
                        var radius1 = Math.sqrt(row.elderly) * 3.5; 
                        L.circle([lat, lng], {
                            color: '#c0392b', fillColor: '#e74c3c', fillOpacity: 0.3, weight: 1, radius: radius1
                        }).bindPopup(`<b>ğŸš¨ ${row.region} ${row.dong}</b><br>ê³ ë ¹ì: ${Number(row.elderly).toLocaleString()}ëª…`).addTo(elderlyLayer);
                    }
                    if (row.poverty) {
                        var radius2 = Math.sqrt(row.poverty) * 6; 
                        L.circle([lat, lng], {
                            color: '#d35400', fillColor: '#e67e22', fillOpacity: 0.4, weight: 1, radius: radius2
                        }).bindPopup(`<b>âš ï¸ ${row.region} ${row.dong}</b><br>ìˆ˜ê¸‰ì: ${Number(row.poverty).toLocaleString()}ëª…`).addTo(povertyLayer);
                    }
                    filledCount++;
                }
            });
            console.log("ì¢Œí‘œ ë§¤ì¹­ ì™„ë£Œ: " + filledCount + "ê°œ ë™");
        }

        function toggleLayer(type, btn) {
            var layer = (type === 'elderly') ? elderlyLayer : povertyLayer;
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
                btn.classList.remove('active');
            } else {
                map.addLayer(layer);
                btn.classList.add('active');
            }
        }

        function filterShelter(category, btnElement) {
            btnElement.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            renderShelters(category);
        }

        function moveDistrict(districtName) {
            var coords = districtCoords[districtName];
            if(coords) map.flyTo(coords, (districtName === 'seoul') ? 12 : 14, { duration: 1.5 });
        }

        function findMyLocation() {
            if (!navigator.geolocation) { alert("ìœ„ì¹˜ ê¸°ëŠ¥ ë¯¸ì§€ì›"); return; }
            navigator.geolocation.getCurrentPosition(pos => {
                map.flyTo([pos.coords.latitude, pos.coords.longitude], 16);
                L.circleMarker([pos.coords.latitude, pos.coords.longitude], { radius: 10, fillColor: "#ff4757", color: "#fff", fillOpacity: 1 }).addTo(map);
            });
        }
        function toggleFullScreen() {
            var elem = document.getElementById('map-wrapper');
            if (!document.fullscreenElement) elem.requestFullscreen().catch(err => alert(err));
            else document.exitFullscreen();
        }
    </script>
</body>
</html>
