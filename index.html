<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì§€êµ¬ë³¸ - ìŠ¤ë§ˆíŠ¸ ë³µì§€ ì§€ë„ (ì§„ë‹¨ëª¨ë“œ)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        #map-wrapper { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; background: #f0f0f0; } /* ë¡œë”© ì „ íšŒìƒ‰ ë°°ê²½ */

        .info-box {
            position: absolute; top: 10px; left: 60px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 260px;
        }
        .layer-btn {
            padding: 8px; border: 1px solid #ddd; background: white; cursor: pointer; width: 48%;
        }
        .layer-btn.active { background: #2c3e50; color: white; }
        .fullscreen-btn { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; border: 0; width: 40px; height: 40px; border-radius: 8px; font-size: 20px; cursor: pointer; }
        
        /* ë²”ë¡€ ê·¸ë¼ë°ì´ì…˜ */
        .legend-bar { height: 10px; width: 100%; background: linear-gradient(to right, #feedde, #a63603); margin: 5px 0; }
    </style>
</head>
<body>

    <div id="map-wrapper">
        <button class="fullscreen-btn" onclick="toggleFullScreen()">â›¶</button>
        <div class="info-box">
            <h2 style="margin:0 0 10px 0; font-size:18px; text-align:center;">ì„œìš¸ì‹œ ë‹¨ê³„êµ¬ë¶„ë„</h2>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="layer-btn active" onclick="setMode('elderly')">ğŸ”´ ê³ ë ¹ì</button>
                <button class="layer-btn" onclick="setMode('poverty')">ğŸŸ  ì·¨ì•½ê³„ì¸µ</button>
            </div>
            <div class="legend-bar" id="legend-bar"></div>
            <div style="display:flex; justify-content:space-between; font-size:11px; color:#666;">
                <span>ì ìŒ</span><span>ë§ìŒ</span>
            </div>
            <p id="status" style="margin-top:10px; font-size:12px; color:blue;">ì‹œìŠ¤í…œ ì ê²€ ì¤‘...</p>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        var map = L.map('map').setView([37.5665, 126.9780], 11);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);

        var geojsonLayer;
        var dongData = {};
        var currentMode = 'elderly';

        // 1. CSV ë°ì´í„° ë¡œë”© í™•ì¸
        var csvUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/seoul_dong_data.csv";
        
        document.getElementById('status').innerText = "1. ë°ì´í„° íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘...";

        Papa.parse(csvUrl, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
            complete: function(results) {
                if (results.data.length === 0) {
                    alert("âš ï¸ ì˜¤ë¥˜: CSV íŒŒì¼ì´ ë¹„ì–´ìˆê±°ë‚˜ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                
                // ë°ì´í„° ë§¤í•‘
                results.data.forEach(row => {
                    if (row.dong) dongData[row.dong] = row;
                });
                
                document.getElementById('status').innerText = `2. ë°ì´í„° ${Object.keys(dongData).length}ê°œ ë¡œë”© ì„±ê³µ. ì§€ë„ ê·¸ë¦¬ëŠ” ì¤‘...`;
                console.log("ë°ì´í„° ë¡œë”© ì„±ê³µ:", dongData);

                // 2. ì§€ë„ ëª¨ì–‘(GeoJSON) ë¡œë”©
                loadGeoJSON();
            },
            error: function(err) {
                alert("âš ï¸ CSV ë¡œë”© ì‹¤íŒ¨! íŒŒì¼ëª…(seoul_dong_data.csv)ì„ í™•ì¸í•˜ì„¸ìš”.\n" + err);
            }
        });

        function loadGeoJSON() {
            var geojsonUrl = "https://raw.githubusercontent.com/southkorea/seoul-maps/master/kostat/2013/json/seoul_dong.geojson";
            
            fetch(geojsonUrl)
                .then(res => {
                    if (!res.ok) throw new Error("ì§€ë„ íŒŒì¼ ì„œë²„ ì‘ë‹µ ì—†ìŒ");
                    return res.json();
                })
                .then(data => {
                    geojsonLayer = L.geoJson(data, {
                        style: styleFeature,
                        onEachFeature: onEachFeature
                    }).addTo(map);
                    document.getElementById('status').innerText = "âœ… ë¶„ì„ ì™„ë£Œ (2026.01.01 ê¸°ì¤€)";
                })
                .catch(err => {
                    alert("âš ï¸ ì§€ë„ ëª¨ì–‘ íŒŒì¼(GeoJSON) ë¡œë”© ì‹¤íŒ¨:\n" + err);
                });
        }

        function styleFeature(feature) {
            var dongName = feature.properties.name;
            var data = dongData[dongName];
            var value = 0;
            
            if (data) {
                value = (currentMode === 'elderly') ? data.elderly : data.poverty;
            }

            return {
                fillColor: getColor(value),
                weight: 1, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7
            };
        }

        function getColor(d) {
            if (currentMode === 'elderly') {
                return d > 6000 ? '#800026' : d > 5000 ? '#BD0026' : d > 4000 ? '#E31A1C' :
                       d > 3000 ? '#FC4E2A' : d > 2000 ? '#FD8D3C' : d > 1000 ? '#FEB24C' : '#FFEDA0';
            } else {
                return d > 2000 ? '#7f2704' : d > 1500 ? '#a63603' : d > 1000 ? '#d94801' :
                       d > 700 ? '#f16913' : d > 400 ? '#fd8d3c' : d > 200 ? '#fdae6b' : '#feedde';
            }
        }

        function onEachFeature(feature, layer) {
            var name = feature.properties.name;
            var data = dongData[name] || { elderly: 0, poverty: 0 };
            layer.bindPopup(`<b>${name}</b><br>ê³ ë ¹ì: ${data.elderly}ëª…<br>ìˆ˜ê¸‰ì: ${data.poverty}ëª…`);
            
            layer.on({
                mouseover: function(e) { e.target.setStyle({ weight: 3, color: '#666', fillOpacity: 0.9 }); },
                mouseout: function(e) { geojsonLayer.resetStyle(e.target); }
            });
        }

        function setMode(mode) {
            currentMode = mode;
            var btns = document.querySelectorAll('.layer-btn');
            btns[0].className = mode === 'elderly' ? 'layer-btn active' : 'layer-btn';
            btns[1].className = mode === 'poverty' ? 'layer-btn active' : 'layer-btn';
            
            var bar = document.getElementById('legend-bar');
            bar.style.background = mode === 'elderly' ? 
                'linear-gradient(to right, #FFEDA0, #800026)' : 'linear-gradient(to right, #feedde, #7f2704)';
            
            if(geojsonLayer) geojsonLayer.setStyle(styleFeature);
        }

        function toggleFullScreen() {
            var el = document.getElementById('map-wrapper');
            if(!document.fullscreenElement) el.requestFullscreen();
            else document.exitFullscreen();
        }
    </script>
</body>
</html>
