<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì§€êµ¬ë³¸ - ìŠ¤ë§ˆíŠ¸ ë³µì§€ ì§€ë„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        #map-wrapper { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; background: #f8f9fa; }

        /* ì •ë³´ ë°•ìŠ¤ */
        .info-box {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(255, 255, 255, 0.98);
            padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            width: 240px;
            font-size: 13px;
        }
        h2 { margin: 0 0 10px 0; font-size: 16px; text-align: center; color: #333; }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .mode-btn, .filter-btn {
            flex: 1; padding: 8px 0; border: 1px solid #ddd; border-radius: 6px;
            background: white; font-size: 11px; font-weight: bold; cursor: pointer;
            text-align: center;
        }
        .mode-btn.active.elderly { background: #e74c3c; color: white; border-color: #e74c3c; }
        .mode-btn.active.poverty { background: #e67e22; color: white; border-color: #e67e22; }
        .filter-btn.active { background: #3498db; color: white; border-color: #3498db; }

        /* ë²”ë¡€ */
        .legend-bar { height: 8px; width: 100%; border-radius: 4px; margin: 5px 0; background: #eee; }
        .legend-labels { display: flex; justify-content: space-between; font-size: 10px; color: #888; }

        /* ë¡œë”© ìƒíƒœ ëª¨ë‹ˆí„° */
        .debug-box {
            position: absolute; bottom: 5px; left: 5px; z-index: 2000;
            background: rgba(0,0,0,0.7); color: #0f0; padding: 5px 10px;
            border-radius: 4px; font-size: 10px; font-family: monospace;
            pointer-events: none;
        }

        .fullscreen-btn { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; border: 0; width: 36px; height: 36px; border-radius: 8px; font-size: 18px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="map-wrapper">
        <button class="fullscreen-btn" onclick="toggleFullScreen()">â›¶</button>
        
        <div class="info-box">
            <h2>ì„œìš¸ì‹œ ë³µì§€ í˜„í™©íŒ</h2>
            
            <div style="font-weight:bold; margin-bottom:5px;">ğŸ“Š ë°°ê²½ ë¶„ì„ (ì¸êµ¬)</div>
            <div class="btn-group">
                <button class="mode-btn active elderly" onclick="setMode('elderly')">ğŸ”´ ê³ ë ¹ì</button>
                <button class="mode-btn poverty" onclick="setMode('poverty')">ğŸŸ  ì·¨ì•½ê³„ì¸µ</button>
            </div>
            <div class="legend-bar" id="legend-bar"></div>
            <div class="legend-labels">
                <span>ì•ˆì „ (ì ìŒ)</span><span>ìœ„í—˜ (ë§ìŒ)</span>
            </div>

            <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">

            <div style="font-weight:bold; margin-bottom:5px;">â›±ï¸ ì‰¼í„° í‘œì‹œ (í•€)</div>
            <div class="btn-group">
                <button class="filter-btn active" onclick="filterShelter('all', this)">ì „ì²´</button>
                <button class="filter-btn" onclick="filterShelter('senior', this)">ê²½ë¡œë‹¹</button>
                <button class="filter-btn" onclick="filterShelter('public', this)">ëˆ„êµ¬ë‚˜</button>
            </div>
        </div>

        <div class="debug-box" id="debug-msg">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>

        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        // --- 1. ì§€ë„ ì´ˆê¸°í™” ---
        var map = L.map('map', { zoomControl: false }).setView([37.5665, 126.9780], 11);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© OpenStreetMap, Â© CARTO'
        }).addTo(map);

        // --- 2. ë³€ìˆ˜ ì„ ì–¸ ---
        var geojsonLayer;
        var markerCluster = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
        var dongData = {}; // CSV ë°ì´í„° ë‹´ì„ ê³³
        var shelterData = []; // ì‰¼í„° ë°ì´í„° ë‹´ì„ ê³³
        var currentMode = 'elderly';

        // --- 3. íŒŒì¼ ê²½ë¡œ (ê¹ƒí—ˆë¸Œ ì£¼ì†Œ) ---
        var URL_DONG_CSV = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/seoul_dong_data.csv";
        var URL_GEOJSON = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/seoul_dong.geojson";
        var URL_SHELTER = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/shelter_data.csv";

        // --- 4. ë¡œê¹… í•¨ìˆ˜ ---
        function log(msg) {
            console.log(msg);
            document.getElementById('debug-msg').innerText = msg;
        }

        // --- 5. ë°ì´í„° ë¡œë”© ì‹œì‘ ---
        log("1. ë™ë³„ ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘...");
        
        Papa.parse(URL_DONG_CSV, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
            complete: function(results) {
                // ë°ì´í„° ë§¤í•‘ (ì´ë¦„ ì •ê·œí™”)
                results.data.forEach(row => {
                    var cleanName = normalizeName(row.full_name || row.dong);
                    if(cleanName) dongData[cleanName] = row;
                });
                log(`1. ë™ ë°ì´í„° ${Object.keys(dongData).length}ê°œ ë¡œë”© ì™„ë£Œ. ì§€ë„ íŒŒì¼ ë°›ëŠ” ì¤‘...`);
                loadGeoJSON(); // ë‹¤ìŒ ë‹¨ê³„
            },
            error: function() { log("âŒ ë™ë³„ ë°ì´í„°(CSV) ë¡œë”© ì‹¤íŒ¨!"); }
        });

        // --- 6. ì§€ë„ ëª¨ì–‘(GeoJSON) ë¡œë”© ---
        function loadGeoJSON() {
            fetch(URL_GEOJSON)
                .then(res => res.json())
                .then(data => {
                    geojsonLayer = L.geoJson(data, {
                        style: styleFeature,
                        onEachFeature: onEachFeature
                    }).addTo(map);
                    
                    log("2. ì§€ë„ ê·¸ë¦¬ê¸° ì™„ë£Œ. ì‰¼í„° í•€ ë¡œë”© ì¤‘...");
                    loadShelters(); // ë‹¤ìŒ ë‹¨ê³„
                })
                .catch(err => log("âŒ ì§€ë„ íŒŒì¼(GeoJSON) ë¡œë”© ì‹¤íŒ¨! íŒŒì¼ëª… í™•ì¸ í•„ìš”."));
        }

        // --- 7. ì‰¼í„° í•€ ë¡œë”© ---
        function loadShelters() {
            Papa.parse(URL_SHELTER, {
                download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
                complete: function(results) {
                    shelterData = results.data;
                    renderShelters('all');
                    setMode('elderly'); // ì´ˆê¸° ìƒ‰ì¹ 
                    log("âœ… ëª¨ë“  ë°ì´í„° ë¡œë”© ë° ë¶„ì„ ì™„ë£Œ!");
                    setTimeout(() => { document.getElementById('debug-msg').style.display = 'none'; }, 5000); // 5ì´ˆ ë’¤ ë©”ì‹œì§€ ìˆ¨ê¹€
                },
                error: function() { log("âŒ ì‰¼í„° ë°ì´í„°(CSV) ë¡œë”© ì‹¤íŒ¨!"); }
            });
        }

        // --- 8. í•µì‹¬ ë¡œì§: ì´ë¦„ ë§¤ì¹­ í†µì—­ê¸° ---
        function normalizeName(name) {
            if (!name) return "";
            // ê°€ìš´ëƒì (Â·)ì„ ë§ˆì¹¨í‘œ(.)ë¡œ, ê³µë°± ì œê±°, íŠ¹ìˆ˜ë¬¸ì í†µì¼
            return name.replace(/Â·/g, ".").replace(/\s+/g, "").trim(); 
        }

        function getDataByFeature(feature) {
            // GeoJSONì— ìˆëŠ” ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (adm_nm: ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬ ì‚¬ì§ë™)
            var rawName = feature.properties.adm_nm || feature.properties.name || "";
            // "ì¢…ë¡œêµ¬ì‚¬ì§ë™" í˜•íƒœë¡œ ë³€í™˜
            var simpleName = rawName.split(" ").slice(1).join(""); // ì„œìš¸íŠ¹ë³„ì‹œ ì œì™¸
            
            // 1ì°¨ ì‹œë„: ê·¸ëƒ¥ ì°¾ê¸°
            var key = normalizeName(rawName); 
            if(dongData[key]) return dongData[key];

            // 2ì°¨ ì‹œë„: "ì¢…ë¡œêµ¬ì‚¬ì§ë™"ìœ¼ë¡œ ì°¾ê¸°
            if(dongData[simpleName]) return dongData[simpleName];

            // 3ì°¨ ì‹œë„: ë§¤í•‘ í…Œì´ë¸” (í–‰ì •êµ¬ì—­ ë³€ê²½ ëŒ€ì‘)
            const mapTable = { 
                "ê°•ë‚¨êµ¬ì¼ì›2ë™": "ê°•ë‚¨êµ¬ê°œí¬3ë™", 
                "ê°•ë™êµ¬ìƒì¼ë™": "ê°•ë™êµ¬ìƒì¼1ë™",
                "ë…¸ì›êµ¬ì¤‘ê³„2.3ë™": "ë…¸ì›êµ¬ì¤‘ê³„2.3ë™", // ê·¸ëŒ€ë¡œ ìœ ì§€
                "ì¢…ë¡œêµ¬ì¢…ë¡œ1.2.3.4ê°€ë™": "ì¢…ë¡œêµ¬ì¢…ë¡œ1.2.3.4ê°€ë™"
            };
            
            // GeoJSON ì´ë¦„ì—ì„œ êµ¬+ë™ë§Œ ì¶”ì¶œí•´ì„œ ë§¤í•‘ í…Œì´ë¸” í™•ì¸
            var shortKey = feature.properties.sggnm + feature.properties.adm_nm.split(" ").pop();
            shortKey = normalizeName(shortKey); // ê°•ë‚¨êµ¬ì¼ì›2ë™

            if(mapTable[shortKey]) {
                var mappedName = normalizeName(mapTable[shortKey]);
                if(dongData[mappedName]) return dongData[mappedName];
            }

            return { elderly: 0, poverty: 0 }; // ì—†ìœ¼ë©´ 0
        }

        // --- 9. ìŠ¤íƒ€ì¼ë§ ë° ê¸°ëŠ¥ ---
        function styleFeature(feature) {
            var data = getDataByFeature(feature);
            var value = (currentMode === 'elderly') ? data.elderly : data.poverty;
            return {
                fillColor: getColor(value),
                weight: 1, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.65
            };
        }

        function getColor(d) {
            if (currentMode === 'elderly') {
                return d > 8000 ? '#800026' : d > 6000 ? '#BD0026' : d > 4000 ? '#E31A1C' : d > 2000 ? '#FC4E2A' : '#FFEDA0';
            } else {
                return d > 2500 ? '#7f2704' : d > 2000 ? '#a63603' : d > 1500 ? '#d94801' : d > 1000 ? '#f16913' : '#feedde';
            }
        }

        function renderShelters(category) {
            markerCluster.clearLayers();
            shelterData.forEach(row => {
                var lat = row['ìœ„ë„'] || row['WGS84ìœ„ë„'];
                var lng = row['ê²½ë„'] || row['WGS84ê²½ë„'];
                var name = row['ì‰¼í„°ëª…ì¹­'] || row['ì‰¼í„°ëª…'] || "ì´ë¦„ì—†ìŒ";
                if (lat && lng) {
                    var isSenior = name.includes("ê²½ë¡œë‹¹") || name.includes("ë…¸ì¸");
                    var show = (category === 'all') || (category === 'senior' && isSenior) || (category === 'public' && !isSenior);
                    if (show) markerCluster.addLayer(L.marker([lat, lng]).bindPopup(`<b>${name}</b>`));
                }
            });
            map.addLayer(markerCluster);
        }

        function filterShelter(category, btnElement) {
            var group = btnElement.parentElement;
            group.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            renderShelters(category);
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.mode-btn.' + mode).classList.add('active');
            var bar = document.getElementById('legend-bar');
            bar.style.background = mode === 'elderly' ? 'linear-gradient(to right, #FFEDA0, #800026)' : 'linear-gradient(to right, #feedde, #7f2704)';
            if(geojsonLayer) geojsonLayer.setStyle(styleFeature);
        }

        function onEachFeature(feature, layer) {
            var data = getDataByFeature(feature);
            var shortName = feature.properties.adm_nm ? feature.properties.adm_nm.split(" ").pop() : feature.properties.name;
            layer.bindPopup(`<div style="text-align:center;"><b>${shortName}</b><hr style="margin:5px 0;">ğŸ”´ ê³ ë ¹ì: ${Number(data.elderly).toLocaleString()}ëª…<br>ğŸŸ  ìˆ˜ê¸‰ì: ${Number(data.poverty).toLocaleString()}ëª…</div>`, { className: 'custom-popup' });
            layer.on({
                mouseover: function(e) { e.target.setStyle({ weight: 3, color: '#333', fillOpacity: 0.9 }); },
                mouseout: function(e) { geojsonLayer.resetStyle(e.target); }
            });
        }

        function toggleFullScreen() {
            var el = document.getElementById('map-wrapper');
            if(!document.fullscreenElement) el.requestFullscreen(); else document.exitFullscreen();
        }
    </script>
</body>
</html>
