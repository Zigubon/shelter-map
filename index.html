<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì„œìš¸ì‹œ ê¸°í›„ìœ„ê¸° ì ì‘ ëª¨ë‹ˆí„°ë§</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        /* 1. ê¸°ë³¸ ì„¤ì • */
        html, body { 
            height: 100%; margin: 0; padding: 0; 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif; 
            background: #f8f9fa; color: #333;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }
        
        /* 2. ì „ì²´ ë ˆì´ì•„ì›ƒ (ìƒí•˜ ë¶„í• ) */
        .dashboard-container {
            display: flex;
            flex-direction: column; /* ìœ„ì—ì„œ ì•„ë˜ë¡œ */
            height: 100vh;
        }

        /* 3. ìƒë‹¨ í—¤ë” & ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .top-panel {
            background: white;
            padding: 12px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            z-index: 2000;
            display: flex;
            flex-wrap: wrap; 
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #e1e4e8;
        }

        .header-title {
            font-size: 18px; font-weight: 800; color: #2c3e50; margin-right: auto; white-space: nowrap;
        }

        /* ì»¨íŠ¸ë¡¤ ê·¸ë£¹ */
        .control-group {
            display: flex; align-items: center; gap: 8px;
            background: #f8f9fa; padding: 4px 8px; border-radius: 8px; border: 1px solid #eee;
        }
        .group-label { font-size: 11px; font-weight: 700; color: #7f8c8d; text-transform: uppercase; margin-right: 5px; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px;
            background: white; font-size: 12px; font-weight: 700; color: #555;
            cursor: pointer; transition: all 0.2s;
        }
        .btn:hover { background: #eee; transform: translateY(-1px); }
        .btn.active { color: white !important; border-color: transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* ìƒ‰ìƒ í…Œë§ˆ */
        .btn.active.elderly { background: #e74c3c !important; }
        .btn.active.poverty { background: #e67e22 !important; }
        .btn.active.filter-btn { background: #2c3e50 !important; }
        .btn.weather { font-weight: 800; color: #3498db; border-color: #3498db; }
        .btn.active.weather { background: #3498db !important; color: white !important; }

        /* 4. í•˜ë‹¨ ì§€ë„ ì˜ì—­ */
        .map-wrapper {
            flex-grow: 1; /* ë‚¨ì€ ê³µê°„ ê½‰ ì±„ìš°ê¸° */
            position: relative;
            background: #eee;
        }
        #map { width: 100%; height: 100%; }

        /* ë²”ë¡€ (ì§€ë„ ìœ„ ì˜¤ë²„ë ˆì´) */
        .legend-overlay {
            position: absolute; bottom: 30px; left: 20px; z-index: 1000;
            background: rgba(255,255,255,0.95); padding: 15px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-size: 11px;
            backdrop-filter: blur(5px); min-width: 150px;
        }

        /* ì§„ë‹¨ ë°°ì§€ (ì˜¤ë¥¸ìª½ ìœ„) */
        .debug-badge {
            font-size: 11px; font-weight: bold; color: #fff; background: #95a5a6;
            padding: 4px 8px; border-radius: 4px;
        }
        
        .fullscreen-btn {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            background: white; border: 0; width: 40px; height: 40px;
            border-radius: 8px; font-size: 20px; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media (max-width: 800px) {
            .top-panel { flex-direction: column; align-items: stretch; gap: 10px; padding: 10px; }
            .header-title { text-align: center; }
            .control-group { justify-content: space-between; }
        }
    </style>
</head>
<body>

<div class="dashboard-container">
    
    <div class="top-panel">
        <div class="header-title">ì„œìš¸ì‹œ ê¸°í›„ìœ„ê¸° ì ì‘ ëª¨ë‹ˆí„°ë§</div>
        
        <button class="btn weather" id="btn-weather" onclick="toggleWeather()">
            ğŸ“¡ ì‹¤ì‹œê°„ ê¸°ì˜¨ (OFF)
        </button>

        <div class="control-group">
            <span class="group-label">ë¶„ì„ ëª¨ë“œ</span>
            <button class="btn mode-btn active elderly" onclick="setMode('elderly')">ê³ ë ¹ì</button>
            <button class="btn mode-btn poverty" onclick="setMode('poverty')">ì·¨ì•½ê³„ì¸µ</button>
        </div>

        <div class="control-group">
            <span class="group-label">ì‰¼í„° í•„í„°</span>
            <button class="btn filter-btn active" onclick="filterShelter('all', this)">ì „ì²´</button>
            <button class="btn filter-btn" onclick="filterShelter('senior', this)">ê²½ë¡œë‹¹</button>
            <button class="btn filter-btn" onclick="filterShelter('public', this)">ê³µê³µ</button>
        </div>

        <div id="data-status" class="debug-badge">ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>

    <div class="map-wrapper" id="map-wrapper">
        <button class="fullscreen-btn" onclick="toggleFullScreen()">â›¶</button>
        
        <div class="legend-overlay" id="dynamic-legend"></div>

        <div id="map"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
    // ==========================================
    // ğŸ”‘ [ì¤‘ìš”] Decoding ì¸ì¦í‚¤
    const API_KEY = "8ad84e9f4adff341e01676520be9f7171b7cfeafaaea9fc8ab7165f0f32e415e"; 
    // ==========================================

    const map = L.map('map', { zoomControl: false }).setView([37.5665, 126.9780], 11);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap, Â© CARTO' }).addTo(map);

    let geojsonLayer, markerCluster = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
    let circleGroup = L.layerGroup().addTo(map);
    let weatherGroup = L.layerGroup().addTo(map);
    
    let dongData = {}, shelterData = [], currentMode = 'elderly', isWeatherOn = false;

    // â˜…â˜…â˜… [ì¤‘ìš”] ì£¼ì†Œë¥¼ 'master'ë¡œ ë‹¤ì‹œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤ â˜…â˜…â˜…
    const URL_DONG = "https://raw.githubusercontent.com/Zigubon/shelter-map/master/seoul_dong_data.csv";
    const URL_GEOJSON = "https://raw.githubusercontent.com/Zigubon/shelter-map/master/seoul_dong.geojson";
    const URL_SHELTER = "https://raw.githubusercontent.com/Zigubon/shelter-map/master/shelter_data.csv";

    const weatherPoints = [
        { name: "ì¢…ë¡œ(ë„ì‹¬)", lat: 37.5730, lng: 126.9794 }, { name: "ê°•ë‚¨", lat: 37.5172, lng: 127.0473 },
        { name: "ë…¸ì›", lat: 37.6542, lng: 127.0568 }, { name: "ì€í‰", lat: 37.6027, lng: 126.9291 },
        { name: "ê°•ì„œ", lat: 37.5509, lng: 126.8497 }, { name: "ê´€ì•…", lat: 37.4784, lng: 126.9516 },
        { name: "ì¤‘ë‘", lat: 37.6066, lng: 127.0927 }
    ];

    function init() {
        updateDebug("CSV ë‹¤ìš´ë¡œë“œ ì¤‘...");
        Papa.parse(URL_DONG, {
            download: true, header: true, skipEmptyLines: true,
            complete: function(res) {
                if(res.data.length === 0) {
                    updateDebug("âŒ CSV ë°ì´í„° ì—†ìŒ");
                    alert("ì˜¤ë¥˜: ë°ì´í„° íŒŒì¼ì´ ë¹„ì–´ìˆê±°ë‚˜ ì£¼ì†Œ(master/main)ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                    return;
                }
                res.data.forEach(row => { if(row.full_name) dongData[normalizeName(row.full_name)] = row; });
                updateDebug(`ë°ì´í„° ${Object.keys(dongData).length}ê°œ ë¡œë”©`);
                loadGeoJSON();
            },
            error: () => updateDebug("âŒ CSV ì‹¤íŒ¨ (ì£¼ì†Œí™•ì¸)")
        });
    }

    function loadGeoJSON() {
        fetch(URL_GEOJSON)
            .then(res => {
                if(!res.ok) throw new Error("404");
                return res.json();
            })
            .then(data => {
                geojsonLayer = L.geoJson(data, { style: styleFeature, onEachFeature: onEachFeature }).addTo(map);
                loadShelters();
            })
            .catch(() => updateDebug("âŒ ì§€ë„ëª¨ì–‘ ì‹¤íŒ¨ (ì£¼ì†Œí™•ì¸)"));
    }

    function loadShelters() {
        Papa.parse(URL_SHELTER, {
            download: true, header: true, skipEmptyLines: true,
            complete: function(res) {
                shelterData = res.data;
                renderShelters('all');
                setMode('elderly');
                updateDebug("âœ… ëª¨ë“  ë°ì´í„° ì •ìƒ");
                setTimeout(() => document.getElementById('data-status').style.display='none', 5000);
            }
        });
    }

    // --- ê¸°ëŠ¥ ë¡œì§ ---

    function toggleWeather() {
        const btn = document.getElementById('btn-weather');
        if (!isWeatherOn) {
            if (API_KEY.includes("ì¸ì¦í‚¤")) { alert("API í‚¤ ì…ë ¥ í•„ìš”"); return; }
            isWeatherOn = true; btn.classList.add('active'); btn.innerText = "ğŸ“¡ ìˆ˜ì‹  ì¤‘...";
            fetchRealTimeWeather();
        } else {
            isWeatherOn = false; btn.classList.remove('active'); btn.innerText = "ğŸ“¡ ì‹¤ì‹œê°„ ê¸°ì˜¨ (OFF)";
            weatherGroup.clearLayers();
        }
    }

    function fetchRealTimeWeather() {
        const now = new Date(); now.setHours(now.getHours() - 1);
        const baseDate = now.toISOString().slice(0,10).replace(/-/g,"");
        const baseTime = String(now.getHours()).padStart(2,'0') + "00";
        let loaded = 0;

        weatherPoints.forEach(pt => {
            const grid = dfs_xy_conv("toXY", pt.lat, pt.lng);
            const url = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtNcst?serviceKey=${API_KEY}&pageNo=1&numOfRows=10&dataType=JSON&base_date=${baseDate}&base_time=${baseTime}&nx=${grid.x}&ny=${grid.y}`;
            
            fetch(url).then(r=>r.json()).then(json => {
                const item = json.response.body.items.item.find(i => i.category === 'T1H');
                if(item) drawWeatherMarker(pt, parseFloat(item.obsrValue));
            }).finally(() => {
                loaded++;
                if(loaded === weatherPoints.length) document.getElementById('btn-weather').innerText = "ğŸ“¡ ìˆ˜ì‹  ì™„ë£Œ (ON)";
            });
        });
    }

    function drawWeatherMarker(pt, temp) {
        let color = temp >= 33 ? '#e74c3c' : temp >= 30 ? '#f39c12' : '#2ecc71';
        const icon = L.divIcon({
            className: 'weather-pin',
            html: `<div style="background:${color}; color:white; padding:4px 8px; border-radius:12px; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3); font-weight:bold; font-size:12px; white-space:nowrap;">${temp}Â°C</div>`
        });
        L.marker([pt.lat, pt.lng], {icon: icon}).addTo(weatherGroup).bindPopup(`<b>${pt.name}</b><br>í˜„ì¬: ${temp}â„ƒ`);
    }

    function styleFeature(feature) {
        var data = getData(feature);
        // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ íˆ¬ëª…í•˜ê²Œ ì²˜ë¦¬í•˜ì§€ ì•Šê³  íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œ (ë””ë²„ê¹…ìš©)
        var hasData = data.elderly > 0 || data.poverty > 0;
        var val = currentMode === 'elderly' ? data.elderly : data.poverty;
        return { 
            fillColor: hasData ? getColor(val) : '#ccc', 
            weight: 1, opacity: 1, color: 'white', dashArray: '3', 
            fillOpacity: hasData ? 0.7 : 0.3 
        };
    }

    function getColor(d) {
        if (currentMode === 'elderly') return d > 8000 ? '#800026' : d > 6000 ? '#BD0026' : d > 4000 ? '#E31A1C' : d > 2000 ? '#FC4E2A' : '#FFEDA0';
        return d > 2500 ? '#7f2704' : d > 2000 ? '#a63603' : d > 1500 ? '#d94801' : d > 1000 ? '#f16913' : '#feedde';
    }

    function renderShelters(cat) {
        markerCluster.clearLayers(); circleGroup.clearLayers();
        shelterData.forEach(row => {
            if(!row['ìœ„ë„']) return;
            let isSenior = (row['ì‰¼í„°ëª…ì¹­']||"").includes("ê²½ë¡œë‹¹");
            if(cat==='all' || (cat==='senior' && isSenior) || (cat==='public' && !isSenior)) {
                markerCluster.addLayer(L.marker([row['ìœ„ë„'], row['ê²½ë„']]).bindPopup(`<b>${row['ì‰¼í„°ëª…ì¹­']}</b>`));
                L.circle([row['ìœ„ë„'], row['ê²½ë„']], { radius: 300, color: 'transparent', fillColor: '#3498db', fillOpacity: 0.1, interactive: false }).addTo(circleGroup);
            }
        });
        map.addLayer(markerCluster);
    }

    function filterShelter(cat, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active'); renderShelters(cat);
    }

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.mode-btn.' + mode).classList.add('active');
        updateLegend();
        if(geojsonLayer) geojsonLayer.setStyle(styleFeature);
    }

    function updateLegend() {
        const conf = currentMode === 'elderly' 
            ? { g: [8000,6000,4000,2000,0], c: ['#800026','#BD0026','#E31A1C','#FC4E2A','#FFEDA0'], t: "ê³ ë ¹ ì¸êµ¬" }
            : { g: [2500,2000,1500,1000,0], c: ['#7f2704','#a63603','#d94801','#f16913','#feedde'], t: "ìˆ˜ê¸‰ì ì¸êµ¬" };
        let html = `<b>${conf.t} (ëª…)</b><br>`;
        conf.g.forEach((v, i) => {
            html += `<i style="background:${conf.c[i]}; width:10px; height:10px; display:inline-block; margin-right:5px; border:1px solid #ccc;"></i>${v}+<br>`;
        });
        html += `<hr style="margin:5px 0;"><i style="background:rgba(52,152,219,0.5); width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:5px; border:1px solid #3498db;"></i>ë°˜ê²½ 300m`;
        document.getElementById('dynamic-legend').innerHTML = html;
    }

    function onEachFeature(f, l) {
        var d = getData(f);
        l.bindPopup(`<center><b>${f.properties.adm_nm.split(" ").pop()}</b><hr>ê³ ë ¹: ${d.elderly.toLocaleString()}ëª…<br>ìˆ˜ê¸‰: ${d.poverty.toLocaleString()}ëª…</center>`);
        l.on({ mouseover: e => { e.target.setStyle({weight:3,color:'#333'}); e.target.openPopup(); }, mouseout: e => { geojsonLayer.resetStyle(e.target); e.target.closePopup(); } });
    }

    function getData(f) {
        // ì´ë¦„ ì •ê·œí™” ë° ë§¤ì¹­ ë¡œì§
        var rawName = f.properties.adm_nm || f.properties.name || "";
        var key = normalizeName(rawName); // "ì„œìš¸íŠ¹ë³„ì‹œì¢…ë¡œêµ¬ì‚¬ì§ë™"
        var simpleKey = normalizeName(rawName.split(" ").slice(1).join("")); // "ì¢…ë¡œêµ¬ì‚¬ì§ë™" (CSVì™€ ì¼ì¹˜ ì˜ˆìƒ)
        
        // ì˜ˆì™¸ ì²˜ë¦¬
        const mapTable = { "ê°•ë‚¨êµ¬ì¼ì›2ë™": "ê°•ë‚¨êµ¬ê°œí¬3ë™", "ê°•ë™êµ¬ìƒì¼ë™": "ê°•ë™êµ¬ìƒì¼1ë™" };
        var shortKey = normalizeName(f.properties.sggnm + f.properties.adm_nm.split(" ").pop());

        if (dongData[key]) return dongData[key];
        if (dongData[simpleKey]) return dongData[simpleKey];
        if (mapTable[shortKey] && dongData[normalizeName(mapTable[shortKey])]) return dongData[normalizeName(mapTable[shortKey])];

        return { elderly: 0, poverty: 0 };
    }
    
    function normalizeName(n) { return n ? n.replace(/Â·/g, ".").replace(/\s+/g, "").trim() : ""; }
    function updateDebug(m) { 
        var el = document.getElementById('data-status');
        el.innerText = m;
        if(m.includes("âŒ")) el.style.background = "#e74c3c"; // ì—ëŸ¬ë©´ ë¹¨ê°„ìƒ‰
        else el.style.background = "#2e7d32"; // ì„±ê³µì´ë©´ ì´ˆë¡ìƒ‰
    }
    function toggleFullScreen() { var el=document.getElementById('map-wrapper'); document.fullscreenElement ? document.exitFullscreen() : el.requestFullscreen(); }

    function dfs_xy_conv(code, v1, v2) {
        var RE = 6371.00877, GRID = 5.0, SLAT1 = 30.0, SLAT2 = 60.0, OLON = 126.0, OLAT = 38.0, XO = 43, YO = 136;
        var DEGRAD = Math.PI / 180.0, RADDEG = 180.0 / Math.PI;
        var re = RE / GRID, slat1 = SLAT1 * DEGRAD, slat2 = SLAT2 * DEGRAD, olon = OLON * DEGRAD, olat = OLAT * DEGRAD;
        var sn = Math.tan(Math.PI * 0.25 + slat2 * 0.5) / Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sn = Math.log(Math.cos(slat1) / Math.cos(slat2)) / Math.log(sn);
        var sf = Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sf = Math.pow(sf, sn) * Math.cos(slat1) / sn;
        var ro = Math.tan(Math.PI * 0.25 + olat * 0.5);
        ro = re * sf / Math.pow(ro, sn);
        var rs = {};
        if (code == "toXY") {
            var ra = Math.tan(Math.PI * 0.25 + (v1) * DEGRAD * 0.5);
            ra = re * sf / Math.pow(ra, sn);
            var theta = v2 * DEGRAD - olon;
            if (theta > Math.PI) theta -= 2.0 * Math.PI;
            if (theta < -Math.PI) theta += 2.0 * Math.PI;
            theta *= sn;
            rs['x'] = Math.floor(ra * Math.sin(theta) + XO + 0.5);
            rs['y'] = Math.floor(ro - ra * Math.cos(theta) + YO + 0.5);
        }
        return rs;
    }

    init();
</script>
</body>
</html>
