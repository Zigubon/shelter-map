<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì§€êµ¬ë³¸ - ë¬´ë”ìœ„ ì‰¼í„° ëª¨ë‹ˆí„°ë§</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        #map { width: 100%; height: 100%; }
        
        /* ì •ë³´ ë°•ìŠ¤ */
        .info-box {
            position: absolute; top: 10px; left: 60px; z-index: 1000;
            background: white; padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: center; min-width: 240px;
        }
        h2 { margin: 0 0 5px 0; font-size: 18px; color: #2c3e50; font-weight: 800; }
        .date-text { margin: 0 0 15px 0; font-size: 12px; color: #888; }
        
        /* â˜… í•„í„° ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
        .filter-group { display: flex; gap: 5px; justify-content: center; margin-bottom: 15px; }
        .filter-btn {
            background: #f1f3f5; border: 1px solid #dee2e6; color: #495057;
            padding: 6px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .filter-btn.active { background: #2c3e50; color: white; border-color: #2c3e50; }
        .filter-btn:hover { background: #e9ecef; }

        /* ë‚´ ìœ„ì¹˜ ë²„íŠ¼ */
        .gps-btn {
            background: #3498db; color: white; border: none;
            padding: 12px; border-radius: 12px;
            font-size: 14px; font-weight: bold; cursor: pointer;
            width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 4px 6px rgba(52, 152, 219, 0.2);
        }
        .gps-btn:hover { background: #2980b9; }

        /* ìƒíƒœ ë©”ì‹œì§€ */
        #status-msg { margin: 10px 0 0 0; font-size: 13px; font-weight: 600; color: #333; }
    </style>
</head>
<body>

    <div class="info-box">
        <h2>ğŸŒ ìŠ¤ë§ˆíŠ¸ ì‰¼í„° ì§€ë„</h2>
        <p class="date-text">(2025-12-30 ê¸°ì¤€)</p>
        
        <div class="filter-group">
            <button class="filter-btn active" onclick="filterData('all', this)">ì „ì²´</button>
            <button class="filter-btn" onclick="filterData('senior', this)">ğŸ‘´ ê²½ë¡œë‹¹</button>
            <button class="filter-btn" onclick="filterData('public', this)">ğŸ¢ ëˆ„êµ¬ë‚˜</button>
        </div>

        <button class="gps-btn" onclick="findMyLocation()">
            ğŸ“ ë‚´ ì£¼ë³€ ì°¾ê¸°
        </button>

        <p id="status-msg">ë°ì´í„° ë¶„ì„ ì¤‘...</p>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        var map = L.map('map', { preferCanvas: true }).setView([37.5665, 126.9780], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

        var markers = L.markerClusterGroup();
        var circles = L.layerGroup();
        var userMarker = null;
        
        // â˜… ë°ì´í„°ë¥¼ ì €ì¥í•´ë‘˜ ë³€ìˆ˜ (í•„í„°ë§í•  ë•Œ ê³„ì† ì“°ë ¤ê³ )
        var allShelterData = [];

        // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        var csvUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/shelter_data.csv";

        Papa.parse(csvUrl, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
            complete: function(results) {
                allShelterData = results.data; // ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                renderMap('all'); // ì²˜ìŒì— ë‹¤ ë³´ì—¬ì£¼ê¸°
            },
            error: function() { alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"); }
        });

        // â˜… ì§€ë„ì— í•€ì„ ì°ëŠ” í•¨ìˆ˜ (í•„í„°ë§ ë¡œì§ í¬í•¨)
        function renderMap(category) {
            markers.clearLayers(); // ê¸°ì¡´ í•€ ì‹¹ ì§€ìš°ê¸°
            circles.clearLayers(); // ê¸°ì¡´ ì› ì‹¹ ì§€ìš°ê¸°
            var count = 0;

            allShelterData.forEach(function(row) {
                var lat = row['ìœ„ë„'] || row['WGS84ìœ„ë„'];
                var lng = row['ê²½ë„'] || row['WGS84ê²½ë„'];
                var name = row['ì‰¼í„°ëª…ì¹­'] || row['ì‰¼í„°ëª…'] || "ì´ë¦„ì—†ìŒ";
                var address = row['ë„ë¡œëª…ì£¼ì†Œ'] || "";

                if (lat && lng) {
                    // í•„í„°ë§ ì¡°ê±´ ê²€ì‚¬
                    var isSenior = name.includes("ê²½ë¡œë‹¹") || name.includes("ë…¸ì¸");
                    var show = false;

                    if (category === 'all') show = true;
                    else if (category === 'senior' && isSenior) show = true;
                    else if (category === 'public' && !isSenior) show = true; // ê²½ë¡œë‹¹ ì•„ë‹Œ ê³³(ì£¼ë¯¼ì„¼í„°, ì€í–‰ ë“±)

                    if (show) {
                        var marker = L.marker([lat, lng]).bindPopup(`<b>${name}</b><br>${address}`);
                        markers.addLayer(marker);
                        
                        // ì› ê·¸ë¦¬ê¸° (íˆ¬ëª…ë„ëŠ” ê°œìˆ˜ì— ë”°ë¼ ì¡°ì ˆ)
                        L.circle([lat, lng], {
                            color: 'transparent', fillColor: '#3498db', fillOpacity: 0.08, radius: 500
                        }).addTo(circles);
                        count++;
                    }
                }
            });

            circles.addTo(map);
            map.addLayer(markers);
            document.getElementById('status-msg').innerText = `ì´ ${count}ê³³ í‘œì‹œ ì¤‘`;
        }

        // ë²„íŠ¼ í´ë¦­ ì‹œ ì‘ë™í•˜ëŠ” í•¨ìˆ˜
        function filterData(category, btnElement) {
            // ë²„íŠ¼ ìƒ‰ê¹” ë°”ê¾¸ê¸°
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            
            // ì§€ë„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            renderMap(category);
        }

        // ë‚´ ìœ„ì¹˜ ì°¾ê¸°
        function findMyLocation() {
            if (!navigator.geolocation) { alert("ìœ„ì¹˜ ê¸°ëŠ¥ ë¯¸ì§€ì›"); return; }
            var btn = document.querySelector('.gps-btn');
            btn.innerHTML = "ğŸ“¡ íƒìƒ‰ ì¤‘...";
            
            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    var lat = pos.coords.latitude;
                    var lng = pos.coords.longitude;
                    map.flyTo([lat, lng], 16);
                    if (userMarker) map.removeLayer(userMarker);
                    userMarker = L.circleMarker([lat, lng], {
                        radius: 10, fillColor: "#ff4757", color: "#fff", weight: 2, fillOpacity: 1
                    }).addTo(map).bindPopup("<b>ğŸš© í˜„ì¬ ë‚´ ìœ„ì¹˜</b>").openPopup();
                    btn.innerHTML = "ğŸ“ ë‚´ ì£¼ë³€ ì°¾ê¸°";
                },
                function() { alert("ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”."); btn.innerHTML = "ğŸ“ ë‚´ ì£¼ë³€ ì°¾ê¸°"; }
            );
        }
    </script>
</body>
</html>
