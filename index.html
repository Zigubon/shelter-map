<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì§€êµ¬ë³¸ - ë¬´ë”ìœ„ ì‰¼í„° ëª¨ë‹ˆí„°ë§</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        #map { width: 100%; height: 100%; }
        
        .info-box {
            position: absolute; top: 10px; left: 60px; z-index: 1000;
            background: white; padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: center; min-width: 240px;
        }
        h2 { margin: 0 0 5px 0; font-size: 18px; color: #2c3e50; font-weight: 800; }
        .date-text { margin: 0 0 10px 0; font-size: 12px; color: #888; }
        
        /* â˜… ìì¹˜êµ¬ ì„ íƒ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .district-select {
            width: 100%; padding: 10px; margin-bottom: 10px;
            border: 1px solid #ddd; border-radius: 12px;
            font-size: 14px; color: #333; font-weight: bold;
            appearance: none; /* ê¸°ë³¸ í™”ì‚´í‘œ ì œê±° (ë¸Œë¼ìš°ì € í†µì¼) */
            background: #f8f9fa url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E") no-repeat right 12px center;
            background-size: 10px; cursor: pointer;
        }
        .district-select:focus { outline: none; border-color: #3498db; }

        .filter-group { display: flex; gap: 5px; justify-content: center; margin-bottom: 15px; }
        .filter-btn {
            background: #f1f3f5; border: 1px solid #dee2e6; color: #495057;
            padding: 6px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .filter-btn.active { background: #2c3e50; color: white; border-color: #2c3e50; }
        
        .gps-btn {
            background: #3498db; color: white; border: none;
            padding: 12px; border-radius: 12px;
            font-size: 14px; font-weight: bold; cursor: pointer;
            width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 4px 6px rgba(52, 152, 219, 0.2);
        }
        .gps-btn:hover { background: #2980b9; }

        #status-msg { margin: 10px 0 0 0; font-size: 13px; font-weight: 600; color: #333; }
    </style>
</head>
<body>

    <div class="info-box">
        <h2>ğŸŒ ìŠ¤ë§ˆíŠ¸ ì‰¼í„° ì§€ë„</h2>
        <p class="date-text">(2025-12-30 ê¸°ì¤€)</p>

        <select class="district-select" onchange="moveDistrict(this.value)">
            <option value="seoul">ğŸ“ ì„œìš¸ì‹œ ì „ì²´ ë³´ê¸°</option>
            <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
            <option value="gangnam">ê°•ë‚¨êµ¬</option>
            <option value="gangdong">ê°•ë™êµ¬</option>
            <option value="gangbuk">ê°•ë¶êµ¬</option>
            <option value="gangseo">ê°•ì„œêµ¬</option>
            <option value="gwanak">ê´€ì•…êµ¬</option>
            <option value="gwangjin">ê´‘ì§„êµ¬</option>
            <option value="guro">êµ¬ë¡œêµ¬</option>
            <option value="geumcheon">ê¸ˆì²œêµ¬</option>
            <option value="nowon">ë…¸ì›êµ¬</option>
            <option value="dobong">ë„ë´‰êµ¬</option>
            <option value="dongdaemun">ë™ëŒ€ë¬¸êµ¬</option>
            <option value="dongjak">ë™ì‘êµ¬</option>
            <option value="mapo">ë§ˆí¬êµ¬</option>
            <option value="seodaemun">ì„œëŒ€ë¬¸êµ¬</option>
            <option value="seocho">ì„œì´ˆêµ¬</option>
            <option value="seongdong">ì„±ë™êµ¬</option>
            <option value="seongbuk">ì„±ë¶êµ¬</option>
            <option value="songpa">ì†¡íŒŒêµ¬</option>
            <option value="yangcheon">ì–‘ì²œêµ¬</option>
            <option value="yeongdeungpo">ì˜ë“±í¬êµ¬</option>
            <option value="yongsan">ìš©ì‚°êµ¬</option>
            <option value="eunpyeong">ì€í‰êµ¬</option>
            <option value="jongno">ì¢…ë¡œêµ¬</option>
            <option value="jung">ì¤‘êµ¬</option>
            <option value="jungnang">ì¤‘ë‘êµ¬</option>
        </select>
        
        <div class="filter-group">
            <button class="filter-btn active" onclick="filterData('all', this)">ì „ì²´</button>
            <button class="filter-btn" onclick="filterData('senior', this)">ğŸ‘´ ê²½ë¡œë‹¹</button>
            <button class="filter-btn" onclick="filterData('public', this)">ğŸ¢ ëˆ„êµ¬ë‚˜</button>
        </div>

        <button class="gps-btn" onclick="findMyLocation()">
            ğŸ“ ë‚´ ì£¼ë³€ ì°¾ê¸°
        </button>

        <p id="status-msg">ë°ì´í„° ë¶„ì„ ì¤‘...</p>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // 1. ì„œìš¸ 25ê°œ ìì¹˜êµ¬ ì¢Œí‘œ ë°ì´í„° (ì¤‘ì‹¬ì )
        const districtCoords = {
            "seoul": [37.5665, 126.9780],
            "gangnam": [37.5172, 127.0473],
            "gangdong": [37.5301, 127.1238],
            "gangbuk": [37.6396, 127.0257],
            "gangseo": [37.5509, 126.8497],
            "gwanak": [37.4784, 126.9516],
            "gwangjin": [37.5385, 127.0823],
            "guro": [37.4954, 126.8874],
            "geumcheon": [37.4565, 126.8954],
            "nowon": [37.6542, 127.0568],
            "dobong": [37.6688, 127.0471],
            "dongdaemun": [37.5744, 127.0400],
            "dongjak": [37.5124, 126.9393],
            "mapo": [37.5663, 126.9016],
            "seodaemun": [37.5791, 126.9368],
            "seocho": [37.4837, 127.0324],
            "seongdong": [37.5633, 127.0371],
            "seongbuk": [37.5891, 127.0182],
            "songpa": [37.5145, 127.1066],
            "yangcheon": [37.5169, 126.8660],
            "yeongdeungpo": [37.5264, 126.8962],
            "yongsan": [37.5326, 126.9905],
            "eunpyeong": [37.6027, 126.9291],
            "jongno": [37.5730, 126.9794],
            "jung": [37.5641, 126.9979],
            "jungnang": [37.6066, 127.0927]
        };

        var map = L.map('map', { preferCanvas: true }).setView(districtCoords["seoul"], 12); // ì´ˆê¸° ì¤Œ 12
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

        var markers = L.markerClusterGroup();
        var circles = L.layerGroup();
        var userMarker = null;
        var allShelterData = [];

        // ë°ì´í„° ë¡œë”©
        var csvUrl = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/shelter_data.csv";

        Papa.parse(csvUrl, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
            complete: function(results) {
                allShelterData = results.data;
                renderMap('all');
            },
            error: function() { alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"); }
        });

        // ì§€ë„ ë Œë”ë§ í•¨ìˆ˜
        function renderMap(category) {
            markers.clearLayers();
            circles.clearLayers();
            var count = 0;

            allShelterData.forEach(function(row) {
                var lat = row['ìœ„ë„'] || row['WGS84ìœ„ë„'];
                var lng = row['ê²½ë„'] || row['WGS84ê²½ë„'];
                var name = row['ì‰¼í„°ëª…ì¹­'] || row['ì‰¼í„°ëª…'] || "ì´ë¦„ì—†ìŒ";
                var address = row['ë„ë¡œëª…ì£¼ì†Œ'] || "";

                if (lat && lng) {
                    var isSenior = name.includes("ê²½ë¡œë‹¹") || name.includes("ë…¸ì¸");
                    var show = false;
                    if (category === 'all') show = true;
                    else if (category === 'senior' && isSenior) show = true;
                    else if (category === 'public' && !isSenior) show = true;

                    if (show) {
                        markers.addLayer(L.marker([lat, lng]).bindPopup(`<b>${name}</b><br>${address}`));
                        L.circle([lat, lng], { color: 'transparent', fillColor: '#3498db', fillOpacity: 0.08, radius: 500 }).addTo(circles);
                        count++;
                    }
                }
            });

            circles.addTo(map);
            map.addLayer(markers);
            document.getElementById('status-msg').innerText = `ì´ ${count}ê³³ í‘œì‹œ ì¤‘`;
        }

        // í•„í„° ë²„íŠ¼ í´ë¦­
        function filterData(category, btnElement) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            renderMap(category);
        }

        // â˜… ìì¹˜êµ¬ ì´ë™ í•¨ìˆ˜
        function moveDistrict(districtName) {
            var coords = districtCoords[districtName];
            if (coords) {
                // ì„œìš¸ ì „ì²´ë©´ ì¤Œì„ ì¢€ ë©€ë¦¬(12), ìì¹˜êµ¬ë©´ ê°€ê¹Œì´(15)
                var zoomLevel = (districtName === 'seoul') ? 12 : 15;
                map.flyTo(coords, zoomLevel, { duration: 1.5 }); // 1.5ì´ˆ ë™ì•ˆ ë¶€ë“œëŸ½ê²Œ ì´ë™
            }
        }

        // ë‚´ ìœ„ì¹˜ ì°¾ê¸°
        function findMyLocation() {
            if (!navigator.geolocation) { alert("ìœ„ì¹˜ ê¸°ëŠ¥ ë¯¸ì§€ì›"); return; }
            var btn = document.querySelector('.gps-btn');
            btn.innerHTML = "ğŸ“¡ íƒìƒ‰ ì¤‘...";
            
            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    var lat = pos.coords.latitude;
                    var lng = pos.coords.longitude;
                    map.flyTo([lat, lng], 16);
                    if (userMarker) map.removeLayer(userMarker);
                    userMarker = L.circleMarker([lat, lng], {
                        radius: 10, fillColor: "#ff4757", color: "#fff", weight: 2, fillOpacity: 1
                    }).addTo(map).bindPopup("<b>ğŸš© í˜„ì¬ ë‚´ ìœ„ì¹˜</b>").openPopup();
                    btn.innerHTML = "ğŸ“ ë‚´ ì£¼ë³€ ì°¾ê¸°";
                },
                function() { alert("ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”."); btn.innerHTML = "ğŸ“ ë‚´ ì£¼ë³€ ì°¾ê¸°"; }
            );
        }
    </script>
</body>
</html>
