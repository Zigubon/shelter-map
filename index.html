<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì„œìš¸ì‹œ ê¸°í›„ìœ„ê¸° ì ì‘ ë° ì‰¼í„° ìµœì í™” ë¶„ì„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; background: #f0f2f5; }
        
        /* ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* 1. ì§€ë„ ì˜ì—­ */
        #map-wrapper { 
            position: relative; width: 100%; height: 75vh; 
            border-radius: 16px; overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            background: white;
        }
        #map { width: 100%; height: 100%; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ (ì§€ë„ ìœ„) */
        .control-panel {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 260px; backdrop-filter: blur(10px);
            max-height: 85vh; overflow-y: auto;
        }
        
        h2 { margin: 0 0 15px 0; font-size: 18px; color: #1a1a1a; font-weight: 800; letter-spacing: -0.5px; }
        .panel-section { margin-bottom: 20px; }
        .section-label { font-size: 12px; font-weight: 700; color: #666; margin-bottom: 8px; display: block; text-transform: uppercase; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§ */
        .btn-group { display: flex; gap: 6px; }
        .btn {
            flex: 1; padding: 8px 0; border: 1px solid #e1e4e8; border-radius: 8px;
            background: white; font-size: 12px; font-weight: 600; color: #4a4a4a;
            cursor: pointer; transition: all 0.2s ease;
        }
        .btn:hover { background: #f8f9fa; transform: translateY(-1px); }
        .btn.active { border-color: transparent; color: white; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
        
        /* ëª¨ë“œë³„ ìƒ‰ìƒ */
        .btn.active.elderly { background: linear-gradient(135deg, #ff6b6b, #ee5253); }
        .btn.active.poverty { background: linear-gradient(135deg, #feca57, #ff9f43); }
        .btn.active.weather { background: linear-gradient(135deg, #48dbfb, #0abde3); } /* ê¸°ìƒ ëª¨ë“œ */
        .btn.active.shelter { background: #2c3e50; }

        /* ë²”ë¡€ */
        .legend-box { background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 11px; }
        .legend-bar { height: 8px; width: 100%; border-radius: 4px; margin: 8px 0; background: #ddd; }
        .legend-labels { display: flex; justify-content: space-between; color: #888; }

        /* 2. ë¦¬í¬íŠ¸ ì˜ì—­ (ì§€ë„ ì•„ë˜) */
        .report-section { margin-top: 20px; }
        /* (ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ì€ ìŠ¤í¬ë¦½íŠ¸ ì•„ë˜ì— ìœ ì§€) */

        .fullscreen-btn { position: absolute; top: 20px; right: 20px; z-index: 1000; background: white; border: 0; width: 44px; height: 44px; border-radius: 12px; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .fullscreen-btn:hover { transform: scale(1.05); }

        /* ë¡œë”©/ì—ëŸ¬ ë©”ì‹œì§€ */
        .status-badge {
            display: inline-block; padding: 4px 8px; border-radius: 4px;
            font-size: 11px; font-weight: bold; margin-top: 10px;
            background: #e8f5e9; color: #2e7d32;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="map-wrapper">
        <button class="fullscreen-btn" onclick="toggleFullScreen()" title="ì „ì²´í™”ë©´">â›¶</button>
        
        <div class="control-panel">
            <h2>ì„œìš¸ì‹œ ê¸°í›„ìœ„ê¸° ê´€ì œ</h2>
            
            <div class="panel-section">
                <span class="section-label">ğŸŒ¡ï¸ ì‹¤ì‹œê°„ ê¸°ìƒ ê´€ì œ (Live)</span>
                <button class="btn weather" id="btn-weather" onclick="toggleWeather()" style="width:100%;">
                    ğŸ“¡ ì‹¤ì‹œê°„ ê¸°ì˜¨ ë°ì´í„° ìˆ˜ì‹  (OFF)
                </button>
                <div id="weather-status" style="font-size:11px; color:#888; margin-top:5px; display:none;">
                    ê¸°ìƒì²­ API ì—°ê²° ì¤‘...
                </div>
            </div>

            <div class="panel-section">
                <span class="section-label">ğŸ“Š ì·¨ì•½ê³„ì¸µ ë°€ì§‘ë„ ë¶„ì„</span>
                <div class="btn-group">
                    <button class="btn mode-btn active elderly" onclick="setMode('elderly')">ğŸ”´ ê³ ë ¹ì</button>
                    <button class="btn mode-btn poverty" onclick="setMode('poverty')">ğŸŸ  ì·¨ì•½ê³„ì¸µ</button>
                </div>
                <div class="legend-box" id="dynamic-legend" style="margin-top:10px;"></div>
            </div>

            <div class="panel-section">
                <span class="section-label">â›±ï¸ ëŒ€ì‘ ìì› (ë¬´ë”ìœ„ì‰¼í„°)</span>
                <div class="btn-group">
                    <button class="btn filter-btn active" onclick="filterShelter('all', this)">ì „ì²´</button>
                    <button class="btn filter-btn" onclick="filterShelter('senior', this)">ê²½ë¡œë‹¹</button>
                    <button class="btn filter-btn" onclick="filterShelter('public', this)">ê³µê³µì‹œì„¤</button>
                </div>
                <div style="font-size:11px; color:#666; margin-top:8px; display:flex; align-items:center;">
                    <span style="width:10px; height:10px; background:rgba(52,152,219,0.2); border:1px solid #3498db; border-radius:50%; margin-right:5px; display:inline-block;"></span>
                    ì ‘ê·¼ì„± ë³´í˜¸ ë°˜ê²½ (300m)
                </div>
            </div>
            
            <div class="status-badge" id="system-status">ì‹œìŠ¤í…œ ëŒ€ê¸° ì¤‘...</div>
        </div>

        <div id="map"></div>
    </div>

    <div class="report-section">
        <style>
            .report-box { background: white; border-radius: 12px; padding: 30px; border: 1px solid #e1e4e8; }
            .report-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
            .roadmap-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
            .roadmap-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #eee; }
            .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; color: white; display: inline-block; margin-bottom: 10px; }
            .badge.p1 { background: #e74c3c; } .badge.p2 { background: #f39c12; } .badge.p3 { background: #27ae60; }
            @media (max-width: 768px) { .roadmap-grid { grid-template-columns: 1fr; } }
        </style>
        <div class="report-box">
            <div class="report-header">
                <h3 style="margin:0;">ğŸ“Œ í”„ë¡œì íŠ¸ ê°œìš” ë° ë¡œë“œë§µ</h3>
                <span style="font-size:13px; color:#666;" id="today-date"></span>
            </div>
            <div>
                <p><strong>ì„œìš¸ì‹œ ê¸°í›„ìœ„ê¸° ì ì‘ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</strong>ì€ ì‹¤ì‹œê°„ ê¸°ìƒ ë°ì´í„°(Hazard)ì™€ ì‚¬íšŒì  ì·¨ì•½ì„±(Vulnerability)ì„ ìœµí•© ë¶„ì„í•˜ì—¬, ë°ì´í„° ê¸°ë°˜ì˜ í­ì—¼ ëŒ€ì‘ ì •ì±…ì„ ì§€ì›í•©ë‹ˆë‹¤.</p>
            </div>
            <div class="roadmap-grid">
                <div class="roadmap-card">
                    <span class="badge p1">Phase 1 (Current)</span><br>
                    <strong>ì‹¤ì‹œê°„ ê¸°ìƒ ê´€ì œ</strong>
                    <p style="font-size:13px; color:#666; margin-top:5px;">ê¸°ìƒì²­ API ì—°ë™ì„ í†µí•œ ì§€ì—­ë³„ ì‹¤ì‹œê°„ ê¸°ì˜¨ ëª¨ë‹ˆí„°ë§ ë° ì‰¼í„° ë§¤ì¹­.</p>
                </div>
                <div class="roadmap-card">
                    <span class="badge p2">Phase 2</span><br>
                    <strong>ë„ì‹œ í™˜ê²½ ë¶„ì„</strong>
                    <p style="font-size:13px; color:#666; margin-top:5px;">ì§€í‘œë©´ ì˜¨ë„(LST) ë° ë…¹ì§€ ë¹„ìœ¨ ë¶„ì„ì„ í†µí•œ ì—´ì„¬ í˜„ìƒ ì›ì¸ ê·œëª….</p>
                </div>
                <div class="roadmap-card">
                    <span class="badge p3">Phase 3</span><br>
                    <strong>ì£¼ê±° ì·¨ì•½ì„± ì‹¬ì¸µ ë¶„ì„</strong>
                    <p style="font-size:13px; color:#666; margin-top:5px;">ë°˜ì§€í•˜/ì˜¥íƒ‘ë°© ì£¼ê±° ë°€ì§‘ë„ì™€ ì—ë„ˆì§€ ë¹ˆê³¤ì¸µ ë°ì´í„°ë¥¼ ê²°í•©í•œ ì •ë°€ íƒ€ê²©.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
    // ==========================================
    // ğŸ”‘ [ì¤‘ìš”] API í‚¤ ì„¤ì • (ì•„ë˜ ë”°ì˜´í‘œ ì•ˆì— í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”)
    const API_KEY = "8ad84e9f4adff341e01676520be9f7171b7cfeafaaea9fc8ab7165f0f32e415e"; 
    // ==========================================

    // 0. ê¸°ë³¸ ì„¤ì •
    const map = L.map('map', { zoomControl: false }).setView([37.5665, 126.9780], 11);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap, Â© CARTO' }).addTo(map);

    // ë‚ ì§œ í‘œì‹œ
    document.getElementById('today-date').innerText = new Date().toLocaleDateString() + " ê¸°ë¡";

    // 1. ë³€ìˆ˜ ë° ë°ì´í„° ì†ŒìŠ¤
    let geojsonLayer;
    let markerCluster = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
    let circleGroup = L.layerGroup().addTo(map); // ì‰¼í„° ë°˜ê²½
    let weatherGroup = L.layerGroup().addTo(map); // ê¸°ìƒ ë°ì´í„° í•€
    
    let dongData = {};
    let shelterData = [];
    let currentMode = 'elderly';
    let isWeatherOn = false;

    const URL_DONG = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/seoul_dong_data.csv";
    const URL_GEOJSON = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/seoul_dong.geojson";
    const URL_SHELTER = "https://raw.githubusercontent.com/Zigubon/shelter-map/refs/heads/main/shelter_data.csv";

    // ê¸°ìƒì²­ ì¢Œí‘œ ë³€í™˜ìš© ì£¼ìš” ì§€ì  (7ê³³ ìƒ˜í”Œë§)
    const weatherPoints = [
        { name: "ì¢…ë¡œêµ¬(ë„ì‹¬)", lat: 37.5730, lng: 126.9794 },
        { name: "ê°•ë‚¨êµ¬", lat: 37.5172, lng: 127.0473 },
        { name: "ë…¸ì›êµ¬(ë™ë¶)", lat: 37.6542, lng: 127.0568 },
        { name: "ì€í‰êµ¬(ì„œë¶)", lat: 37.6027, lng: 126.9291 },
        { name: "ê°•ì„œêµ¬(ì„œë‚¨)", lat: 37.5509, lng: 126.8497 },
        { name: "ê´€ì•…êµ¬(ë‚¨ë¶€)", lat: 37.4784, lng: 126.9516 },
        { name: "ì¤‘ë‘êµ¬(ë™ë¶€)", lat: 37.6066, lng: 127.0927 }
    ];

    // 2. ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë”© íŒŒì´í”„ë¼ì¸
    function init() {
        updateStatus("1. ë°ì´í„° ë¡œë”© ì¤‘...");
        Papa.parse(URL_DONG, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
            complete: function(res) {
                res.data.forEach(row => {
                    let name = normalizeName(row.full_name || row.dong);
                    if(name) dongData[name] = row;
                });
                loadGeoJSON();
            },
            error: () => updateStatus("âŒ CSV ë¡œë”© ì‹¤íŒ¨")
        });
    }

    function loadGeoJSON() {
        updateStatus("2. ì§€ë„ ìƒì„± ì¤‘...");
        fetch(URL_GEOJSON)
            .then(res => res.json())
            .then(data => {
                geojsonLayer = L.geoJson(data, { style: styleFeature, onEachFeature: onEachFeature }).addTo(map);
                loadShelters();
            })
            .catch(() => updateStatus("âŒ ì§€ë„ íŒŒì¼ ë¡œë”© ì‹¤íŒ¨"));
    }

    function loadShelters() {
        updateStatus("3. ì‰¼í„° í•€ ì„¤ì¹˜ ì¤‘...");
        Papa.parse(URL_SHELTER, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true, encoding: "UTF-8",
            complete: function(res) {
                shelterData = res.data;
                renderShelters('all');
                setMode('elderly'); // ì´ˆê¸° ëª¨ë“œ
                updateStatus("âœ… ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ");
            }
        });
    }

    // 3. ê¸°ìƒì²­ API ì—°ë™ (í•µì‹¬ ê¸°ëŠ¥)
    function toggleWeather() {
        const btn = document.getElementById('btn-weather');
        const status = document.getElementById('weather-status');
        
        if (!isWeatherOn) {
            // ì¼œê¸°
            if (API_KEY === "ì—¬ê¸°ì—_ì¸ì¦í‚¤ë¥¼_ë¶™ì—¬ë„£ìœ¼ì„¸ìš”" || API_KEY.length < 10) {
                alert("âš ï¸ API ì¸ì¦í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nì½”ë“œ ë‚´ 'API_KEY' ë³€ìˆ˜ì— ì¸ì¦í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            isWeatherOn = true;
            btn.classList.add('active');
            btn.innerText = "ğŸ“¡ ì‹¤ì‹œê°„ ê¸°ì˜¨ ìˆ˜ì‹  ì¤‘ (ON)";
            status.style.display = "block";
            status.innerText = "ê¸°ìƒì²­ ì„œë²„ì— ë°ì´í„° ìš”ì²­ ì¤‘...";
            
            weatherGroup.clearLayers();
            fetchRealTimeWeather();
        } else {
            // ë„ê¸°
            isWeatherOn = false;
            btn.classList.remove('active');
            btn.innerText = "ğŸ“¡ ì‹¤ì‹œê°„ ê¸°ì˜¨ ë°ì´í„° ìˆ˜ì‹  (OFF)";
            status.style.display = "none";
            weatherGroup.clearLayers();
        }
    }

    function fetchRealTimeWeather() {
        // ì˜¤ëŠ˜ ë‚ ì§œì™€ ì‹œê°„ ê³„ì‚° (ë§¤ì‹œ ì •ê° ê¸°ì¤€)
        const now = new Date();
        // ê¸°ìƒì²­ APIëŠ” 40ë¶„ ì´í›„ì— í•´ë‹¹ ì‹œê°„ ë°ì´í„° ì œê³µ (ì•ˆì •ì„±ì„ ìœ„í•´ 1ì‹œê°„ ì „ ë°ì´í„° ìš”ì²­)
        now.setHours(now.getHours() - 1); 
        
        const baseDate = now.getFullYear() + 
                         String(now.getMonth()+1).padStart(2,'0') + 
                         String(now.getDate()).padStart(2,'0');
        const baseTime = String(now.getHours()).padStart(2,'0') + "00";

        let loadedCount = 0;

        weatherPoints.forEach(point => {
            // ì¢Œí‘œ ë³€í™˜
            const grid = dfs_xy_conv("toXY", point.lat, point.lng);
            
            // API í˜¸ì¶œ
            const url = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtNcst?serviceKey=${API_KEY}&pageNo=1&numOfRows=10&dataType=JSON&base_date=${baseDate}&base_time=${baseTime}&nx=${grid.x}&ny=${grid.y}`;

            fetch(url)
                .then(res => res.json())
                .then(json => {
                    const items = json.response.body.items.item;
                    const tempItem = items.find(item => item.category === 'T1H'); // ê¸°ì˜¨
                    if(tempItem) {
                        const temp = parseFloat(tempItem.obsrValue);
                        drawWeatherMarker(point, temp);
                    }
                })
                .catch(err => console.error("API Error:", err))
                .finally(() => {
                    loadedCount++;
                    if(loadedCount === weatherPoints.length) {
                        document.getElementById('weather-status').innerText = `âœ… ${baseTime.substr(0,2)}ì‹œ ê¸°ì¤€ ê´€ì¸¡ ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œ`;
                    }
                });
        });
    }

    function drawWeatherMarker(point, temp) {
        let color = '#2ecc71'; // ì•ˆì „ (30ë„ ë¯¸ë§Œ)
        if (temp >= 30) color = '#f39c12'; // ì£¼ì˜
        if (temp >= 33) color = '#e74c3c'; // ê²½ê³ 

        const iconHtml = `
            <div style="background:${color}; color:white; padding:5px 8px; border-radius:12px; font-weight:bold; font-size:12px; box-shadow:0 2px 5px rgba(0,0,0,0.3); border:2px solid white; white-space:nowrap;">
                ${temp}Â°C
            </div>
        `;
        
        const icon = L.divIcon({
            className: 'custom-weather-icon',
            html: iconHtml,
            iconSize: [50, 30],
            iconAnchor: [25, 15]
        });

        L.marker([point.lat, point.lng], { icon: icon }).addTo(weatherGroup)
         .bindPopup(`<b>${point.name}</b><br>í˜„ì¬ ê¸°ì˜¨: ${temp}â„ƒ`);
    }


    // 4. ìœ í‹¸ë¦¬í‹° ë° ì§€ë„ ê¸°ëŠ¥
    function normalizeName(name) {
        if (!name) return "";
        return name.replace(/Â·/g, ".").replace(/\s+/g, "").trim(); 
    }
    
    function updateStatus(msg) { document.getElementById('system-status').innerText = msg; }

    // ê¸°ìƒì²­ ì¢Œí‘œ ë³€í™˜ í•¨ìˆ˜ (Lamcproj)
    function dfs_xy_conv(code, v1, v2) {
        var RE = 6371.00877, GRID = 5.0, SLAT1 = 30.0, SLAT2 = 60.0, OLON = 126.0, OLAT = 38.0, XO = 43, YO = 136;
        var DEGRAD = Math.PI / 180.0, RADDEG = 180.0 / Math.PI;
        var re = RE / GRID, slat1 = SLAT1 * DEGRAD, slat2 = SLAT2 * DEGRAD, olon = OLON * DEGRAD, olat = OLAT * DEGRAD;
        var sn = Math.tan(Math.PI * 0.25 + slat2 * 0.5) / Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sn = Math.log(Math.cos(slat1) / Math.cos(slat2)) / Math.log(sn);
        var sf = Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sf = Math.pow(sf, sn) * Math.cos(slat1) / sn;
        var ro = Math.tan(Math.PI * 0.25 + olat * 0.5);
        ro = re * sf / Math.pow(ro, sn);
        var rs = {};
        if (code == "toXY") {
            var ra = Math.tan(Math.PI * 0.25 + (v1) * DEGRAD * 0.5);
            ra = re * sf / Math.pow(ra, sn);
            var theta = v2 * DEGRAD - olon;
            if (theta > Math.PI) theta -= 2.0 * Math.PI;
            if (theta < -Math.PI) theta += 2.0 * Math.PI;
            theta *= sn;
            rs['x'] = Math.floor(ra * Math.sin(theta) + XO + 0.5);
            rs['y'] = Math.floor(ro - ra * Math.cos(theta) + YO + 0.5);
        }
        return rs;
    }

    // ì§€ë„ ìŠ¤íƒ€ì¼ë§
    function getDataByFeature(feature) {
        var rawName = feature.properties.adm_nm || feature.properties.name || "";
        var key = normalizeName(rawName);
        var simpleKey = normalizeName(rawName.split(" ").slice(1).join(""));
        
        // ë§¤í•‘ í…Œì´ë¸” (ì˜ˆì™¸ ì²˜ë¦¬)
        const mapTable = { "ê°•ë‚¨êµ¬ì¼ì›2ë™": "ê°•ë‚¨êµ¬ê°œí¬3ë™", "ê°•ë™êµ¬ìƒì¼ë™": "ê°•ë™êµ¬ìƒì¼1ë™" };
        var shortKey = normalizeName(feature.properties.sggnm + feature.properties.adm_nm.split(" ").pop());

        if (dongData[key]) return dongData[key];
        if (dongData[simpleKey]) return dongData[simpleKey];
        if (mapTable[shortKey] && dongData[normalizeName(mapTable[shortKey])]) return dongData[normalizeName(mapTable[shortKey])];

        return { elderly: 0, poverty: 0 };
    }

    function styleFeature(feature) {
        var data = getDataByFeature(feature);
        var value = (currentMode === 'elderly') ? data.elderly : data.poverty;
        return { fillColor: getColor(value), weight: 1, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7 };
    }

    function getColor(d) {
        if (currentMode === 'elderly') return d > 8000 ? '#800026' : d > 6000 ? '#BD0026' : d > 4000 ? '#E31A1C' : d > 2000 ? '#FC4E2A' : '#FFEDA0';
        return d > 2500 ? '#7f2704' : d > 2000 ? '#a63603' : d > 1500 ? '#d94801' : d > 1000 ? '#f16913' : '#feedde';
    }

    function renderShelters(category) {
        markerCluster.clearLayers(); circleGroup.clearLayers();
        shelterData.forEach(row => {
            var lat = row['ìœ„ë„'] || row['WGS84ìœ„ë„'], lng = row['ê²½ë„'] || row['WGS84ê²½ë„'], name = row['ì‰¼í„°ëª…ì¹­'] || row['ì‰¼í„°ëª…'];
            if(lat && lng) {
                var isSenior = (name||"").includes("ê²½ë¡œë‹¹") || (name||"").includes("ë…¸ì¸");
                if((category==='all') || (category==='senior' && isSenior) || (category==='public' && !isSenior)) {
                    markerCluster.addLayer(L.marker([lat, lng]).bindPopup(`<b>${name}</b>`));
                    L.circle([lat, lng], { radius: 300, color: 'transparent', fillColor: '#3498db', fillOpacity: 0.15, interactive: false }).addTo(circleGroup);
                }
            }
        });
        map.addLayer(markerCluster);
    }

    function filterShelter(cat, btn) {
        btn.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderShelters(cat);
    }

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.mode-btn.' + mode).classList.add('active');
        updateLegend();
        if(geojsonLayer) geojsonLayer.setStyle(styleFeature);
    }

    function updateLegend() {
        const container = document.getElementById('dynamic-legend');
        const config = currentMode === 'elderly' 
            ? { grades: [8000, 6000, 4000, 2000, 0], colors: ['#800026', '#BD0026', '#E31A1C', '#FC4E2A', '#FFEDA0'], label: "ê³ ë ¹ ì¸êµ¬" }
            : { grades: [2500, 2000, 1500, 1000, 0], colors: ['#7f2704', '#a63603', '#d94801', '#f16913', '#feedde'], label: "ìˆ˜ê¸‰ì ì¸êµ¬" };
            
        let html = `<div style="font-weight:bold; margin-bottom:5px; color:#555;">${config.label} (ëª…)</div>`;
        for(let i=0; i<config.grades.length; i++) {
            let label = (i===0) ? `${config.grades[i]}+` : `${config.grades[i]}~${config.grades[i-1]}`;
            html += `<div style="display:flex; align-items:center; margin-bottom:3px;"><span style="width:12px; height:12px; background:${config.colors[i]}; margin-right:8px; border:1px solid #ccc;"></span><span>${label}</span></div>`;
        }
        container.innerHTML = html;
    }

    function onEachFeature(feature, layer) {
        var data = getDataByFeature(feature);
        var name = (feature.properties.adm_nm || "").split(" ").pop();
        layer.bindPopup(`<div style="text-align:center;"><b>${name}</b><hr>ğŸ”´ ê³ ë ¹ì: ${data.elderly}ëª…<br>ğŸŸ  ìˆ˜ê¸‰ì: ${data.poverty}ëª…</div>`);
        layer.on({ mouseover: function(e) { e.target.setStyle({weight:3, color:'#333', fillOpacity:0.9}); e.target.openPopup(); }, mouseout: function(e) { geojsonLayer.resetStyle(e.target); e.target.closePopup(); } });
    }

    function toggleFullScreen() {
        const el = document.getElementById('map-wrapper');
        if(!document.fullscreenElement) el.requestFullscreen(); else document.exitFullscreen();
    }

    // ì‹¤í–‰
    init();

</script>
</body>
</html>
